# åŠ¨æ€å­—æ®µè·å–é€»è¾‘è¯´æ˜

## ğŸ“‹ æ•´ä½“æµç¨‹æ¦‚è§ˆ

```
ç”¨æˆ·æ“ä½œ/é¡µé¢åŠ è½½
    â†“
è·å– typeid (æ ç›®ID)
    â†“
è·å– channel_id (æ¨¡å‹ID/é¢‘é“ID)
    â†“
è¯·æ±‚åŠ¨æ€å­—æ®µæ•°æ®
    â†“
æ¸²æŸ“å­—æ®µåˆ°é¡µé¢
    â†“
åˆå§‹åŒ–ç¼–è¾‘å™¨å’Œä¸Šä¼ ç»„ä»¶
```

---

## ğŸ”„ è¯¦ç»†æµç¨‹åˆ†æ

### ä¸€ã€è§¦å‘æ—¶æœº

#### **insert.html (æ–°å¢é¡µé¢)**
1. **é¡µé¢åŠ è½½æ—¶**ï¼šä¸è‡ªåŠ¨åŠ è½½ï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©æ ç›®
2. **æ ç›®é€‰æ‹©å˜åŒ–æ—¶**ï¼š
   ```javascript
   form.on('select(typeid)', function (data) {
       var typeid = data.value;
       if (typeid && typeid > 0) {
           loadChannelfields(typeid);  // è§¦å‘åŠ è½½
       }
   });
   ```

#### **update.html (ç¼–è¾‘é¡µé¢)**
1. **é¡µé¢åŠ è½½æ—¶**ï¼šè‡ªåŠ¨åŠ è½½
   ```javascript
   reloadFormData() 
       â†’ è·å–æ•°æ®åº“æ•°æ® 
       â†’ loadChannelfields(typeid, channelId, aid)
   ```
2. **æ ç›®é€‰æ‹©å˜åŒ–æ—¶**ï¼šåŒ insert.html

---

### äºŒã€è·å– channel_id çš„é€»è¾‘

#### **insert.html çš„é€»è¾‘**ï¼ˆä¼˜åŒ–åï¼Œä¼˜å…ˆä½¿ç”¨URLå‚æ•°ï¼‰

```javascript
function loadChannelfields(typeid) {
    // æ­¥éª¤1: ä¼˜å…ˆä»URLå‚æ•°è·å–channelIdï¼ˆé¿å…é‡å¤è¯·æ±‚ï¼‰
    var urlParams = new URLSearchParams(window.location.search);
    var channelId = parseInt(urlParams.get('channel_id')) || 0;
    
    // æ­¥éª¤2: å¦‚æœURLå‚æ•°ä¸­æ²¡æœ‰channelIdï¼Œæ‰è¯·æ±‚åç«¯è·å–æ ç›®ä¿¡æ¯
    if (channelId === 0) {
        $.ajax({
            url: "/app/admin/arctype/select",
            data: { id: typeid },
            success: function (result) {
                var arctypeData = result.data[0];
                channelId = parseInt(arctypeData.current_channel) || 0;
                if (channelId > 0) {
                    loadChannelfieldsByChannelId(typeid, channelId);
                }
            }
        });
    } else {
        // æ­¥éª¤3: ç›´æ¥ä½¿ç”¨URLå‚æ•°ä¸­çš„channelId
        loadChannelfieldsByChannelId(typeid, channelId);
    }
}
```

**æ•°æ®æ¥æºä¼˜å…ˆçº§**ï¼š
1. âœ… **URLå‚æ•°** `?channel_id=xxx` ï¼ˆæœ€ä¼˜ï¼Œé¿å…é‡å¤è¯·æ±‚ï¼‰
2. â¬‡ï¸ **åç«¯æ¥å£** `/app/admin/arctype/select?id=xxx` â†’ è·å– `current_channel`

#### **update.html çš„é€»è¾‘**ï¼ˆä¼˜å…ˆä½¿ç”¨æ•°æ®åº“æ•°æ®ï¼‰

```javascript
function loadChannelfields(typeid, channelId, aid) {
    // channelId ç›´æ¥æ¥è‡ªæ•°æ®åº“çš„ archiveData.channel
    // å¦‚æœ channelId ä¸º 0ï¼Œæç¤ºé”™è¯¯ï¼Œä¸è¯·æ±‚
    if (!channelId || channelId === 0) {
        layui.pearPopup.failure("é¢‘é“IDä¸å­˜åœ¨ï¼Œæ— æ³•åŠ è½½åŠ¨æ€å­—æ®µ");
        return;
    }
    
    // ç›´æ¥ä½¿ç”¨ä¼ å…¥çš„ channelId
    loadChannelfieldsByChannelId(typeid, channelId);
}
```

**æ•°æ®æ¥æº**ï¼š
- âœ… **æ•°æ®åº“æ•°æ®** `archiveData.channel` ï¼ˆä» `reloadFormData()` è·å–ï¼‰

---

### ä¸‰ã€è¯·æ±‚åŠ¨æ€å­—æ®µæ•°æ®

```javascript
function loadChannelfieldsByChannelId(typeid, channelId) {
    if (channelId <= 0) {
        return;
    }
    
    var requestData = {
        channel_id: channelId,    // æ¨¡å‹ID
        limit: 1000,             // é™åˆ¶æ•°é‡
        is_release: 1,           // åªè·å–å·²å‘å¸ƒçš„å­—æ®µ
        typeid: typeid           // æ ç›®ID
    };

    $.ajax({
        url: "/app/admin/channelfield/select",  // å­—æ®µæ¥å£
        type: 'get',
        dataType: 'json',
        data: requestData,
        success: function (result) {
            if (result.code === 0 && result.data) {
                renderFields(result.data);  // æ¸²æŸ“å­—æ®µ
            }
        }
    });
}
```

**æ¥å£è¯´æ˜**ï¼š
- **URL**: `/app/admin/channelfield/select`
- **å‚æ•°**:
  - `channel_id`: æ¨¡å‹IDï¼ˆå¿…éœ€ï¼‰
  - `typeid`: æ ç›®ID
  - `limit`: é™åˆ¶æ•°é‡
  - `is_release`: æ˜¯å¦å·²å‘å¸ƒï¼ˆ1=å·²å‘å¸ƒï¼‰

---

### å››ã€æ¸²æŸ“å­—æ®µåˆ°é¡µé¢

```javascript
function renderFields(fields) {
    // 1. æ¸…ç©ºä¹‹å‰çš„åŠ¨æ€å­—æ®µ
    $('#dynamic-fields-container-1').empty();  // åŸºç¡€å†…å®¹æ ‡ç­¾é¡µ
    $('#dynamic-fields-container-2').empty();  // SEOä¼˜åŒ–æ ‡ç­¾é¡µ
    $('#dynamic-fields-container-3').empty();  // æ›´å¤šè®¾ç½®æ ‡ç­¾é¡µ
    
    // 2. å¤„ç† content å’Œ content_ey_m å­—æ®µï¼ˆç‰¹æ®Šå¤„ç†ï¼‰
    //    - æ£€æŸ¥å­—æ®µæ˜¯å¦å­˜åœ¨
    //    - æ ¹æ® ifeditable çŠ¶æ€æ˜¾ç¤º/éšè—æ ‡ç­¾é¡µ
    
    // 3. æŒ‰æ ‡ç­¾é¡µåˆ†ç±»å­—æ®µ
    var tabFields = { 1: [], 2: [], 3: [] };
    fields.forEach(function (field) {
        if (field.ifeditable != 1) return;  // è·³è¿‡ä¸å¯ç¼–è¾‘å­—æ®µ
        
        var fieldName = field.name || '';
        if (fieldName === 'content' || fieldName === 'content_ey_m') {
            return;  // è·³è¿‡ï¼Œå·²å•ç‹¬å¤„ç†
        }
        
        var tabIndex = getFieldTabIndex(fieldName);  // è·å–å­—æ®µæ‰€å±æ ‡ç­¾é¡µ
        tabFields[tabIndex].push(field);
    });
    
    // 4. æ¸²æŸ“æ¯ä¸ªæ ‡ç­¾é¡µçš„å­—æ®µ
    [1, 2, 3].forEach(function (tabIndex) {
        renderTabFields(tabFields[tabIndex], tabIndex);
    });
    
    // 5. åˆå§‹åŒ–ç¼–è¾‘å™¨å’Œä¸Šä¼ ç»„ä»¶
    initEditorsAndUploads();
}
```

**å­—æ®µåˆ†ç±»è§„åˆ™**ï¼ˆ`getFieldTabIndex`ï¼‰ï¼š
- **æ ‡ç­¾é¡µ1ï¼ˆåŸºç¡€å†…å®¹ï¼‰**: é»˜è®¤ï¼Œå…¶ä»–å­—æ®µ
- **æ ‡ç­¾é¡µ2ï¼ˆSEOä¼˜åŒ–ï¼‰**: `seo_title`, `seo_keywords`, `seo_description`
- **æ ‡ç­¾é¡µ3ï¼ˆæ›´å¤šè®¾ç½®ï¼‰**: `author`, `origin`, `click`, `arcrank`, `add_time` ç­‰

---

### äº”ã€ç”Ÿæˆå­—æ®µHTML

```javascript
function renderTabFields(fields, tabIndex) {
    var $container = $('#dynamic-fields-container-' + tabIndex);
    fields.forEach(function (field) {
        $container.append(generateFieldHtml(field));  // ç”ŸæˆHTMLå¹¶è¿½åŠ 
    });
}
```

**`generateFieldHtml` æ”¯æŒçš„å­—æ®µç±»å‹**ï¼š
- `htmltext`: å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
- `text`, `int`, `float`, `datetime`: æ–‡æœ¬è¾“å…¥æ¡†
- `textarea`: å¤šè¡Œæ–‡æœ¬
- `select`, `selects`: ä¸‹æ‹‰é€‰æ‹©
- `radio`, `radios`: å•é€‰æŒ‰é’®
- `checkbox`, `checkboxs`: å¤é€‰æ¡†
- `img`: å•å›¾ä¸Šä¼ 
- `imgs`: å¤šå›¾ä¸Šä¼ 
- `files`: æ–‡ä»¶ä¸Šä¼ 
- `switch`: å¼€å…³
- `decimal`: å°æ•°
- `multitext`: å¤šè¡Œæ–‡æœ¬

---

### å…­ã€åˆå§‹åŒ–ç¼–è¾‘å™¨å’Œä¸Šä¼ ç»„ä»¶

```javascript
function initEditorsAndUploads() {
    // 1. åˆå§‹åŒ– content å’Œ content_ey_m ç¼–è¾‘å™¨ï¼ˆTinyMCEï¼‰
    // 2. åˆå§‹åŒ–å…¶ä»– htmltext ç±»å‹å­—æ®µçš„ç¼–è¾‘å™¨
    // 3. åˆå§‹åŒ–ä¸Šä¼ ç»„ä»¶ï¼ˆimg, imgs, filesï¼‰
}
```

---

## ğŸ“Š æ•°æ®æµå‘å›¾

### insert.html
```
ç”¨æˆ·é€‰æ‹©æ ç›®
    â†“
loadChannelfields(typeid)
    â†“
è·å– channel_id (URLå‚æ•° æˆ– åç«¯æ¥å£)
    â†“
loadChannelfieldsByChannelId(typeid, channelId)
    â†“
è¯·æ±‚ /app/admin/channelfield/select
    â†“
renderFields(fields)
    â†“
ç”ŸæˆHTML â†’ åˆå§‹åŒ–ç¼–è¾‘å™¨/ä¸Šä¼ 
```

### update.html
```
é¡µé¢åŠ è½½
    â†“
reloadFormData()
    â†“
è·å–æ•°æ®åº“æ•°æ® (åŒ…å« typeid, channel, aid)
    â†“
loadChannelfields(typeid, channelId, aid)
    â†“
è¯·æ±‚ /app/admin/channelfield/select
    â†“
renderFields(fields)
    â†“
loadContentData(aid, channelId, fields)  // å¡«å……å­—æ®µæ•°æ®
    â†“
ç”ŸæˆHTML â†’ åˆå§‹åŒ–ç¼–è¾‘å™¨/ä¸Šä¼  â†’ å¡«å……æ•°æ®
```

---

## ğŸ”‘ å…³é”®ä»£ç ä½ç½®

### insert.html
- **è§¦å‘**: ç¬¬394è¡Œ `form.on('select(typeid)')`
- **è·å–channelId**: ç¬¬523-549è¡Œ `loadChannelfields()`
- **è¯·æ±‚å­—æ®µ**: ç¬¬552-573è¡Œ `loadChannelfieldsByChannelId()`
- **æ¸²æŸ“å­—æ®µ**: ç¬¬577-707è¡Œ `renderFields()`

### update.html
- **è§¦å‘**: ç¬¬430è¡Œ `reloadFormData()` æˆ– ç¬¬401è¡Œ `form.on('select(typeid)')`
- **è·å–channelId**: ç¬¬658è¡Œ `archiveData.channel`ï¼ˆæ¥è‡ªæ•°æ®åº“ï¼‰
- **è¯·æ±‚å­—æ®µ**: ç¬¬679-711è¡Œ `loadChannelfields()`
- **æ¸²æŸ“å­—æ®µ**: ç¬¬857-1050è¡Œ `renderFields()`
- **å¡«å……æ•°æ®**: ç¬¬818-856è¡Œ `loadContentData()`

---

## ğŸ’¡ ä¼˜åŒ–ç‚¹è¯´æ˜

1. **insert.html**: ä¼˜å…ˆä½¿ç”¨URLå‚æ•° `channel_id`ï¼Œé¿å…é‡å¤è¯·æ±‚åç«¯
2. **update.html**: ä¼˜å…ˆä½¿ç”¨æ•°æ®åº“ä¸­çš„ `channel`ï¼Œå¦‚æœä¸º0åˆ™æç¤ºé”™è¯¯
3. **ç¼–è¾‘å™¨åˆå§‹åŒ–**: ä½¿ç”¨ `requestAnimationFrame` å‡å°‘å»¶è¿Ÿæ„Ÿ
4. **å­—æ®µåˆ†ç±»**: æ ¹æ®å­—æ®µåè‡ªåŠ¨åˆ†é…åˆ°å¯¹åº”æ ‡ç­¾é¡µ

---

## ğŸ¯ æ ¸å¿ƒAPIæ¥å£

| æ¥å£ | ç”¨é€” | å‚æ•° |
|------|------|------|
| `/app/admin/arctype/select` | è·å–æ ç›®ä¿¡æ¯ | `id`: æ ç›®ID æˆ– `format=tree`: æ ‘å½¢ç»“æ„ |
| `/app/admin/channelfield/select` | è·å–åŠ¨æ€å­—æ®µ | `channel_id`, `typeid`, `limit`, `is_release` |
| `/app/admin/archive/getContent` | è·å–é™„åŠ è¡¨æ•°æ®ï¼ˆupdate.htmlï¼‰ | `aid`, `channel_id` |

