<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <title>更新页面</title>
    <link rel="stylesheet" href="/app/admin/component/pear/css/pear.css" />
    <link rel="stylesheet" href="/app/admin/component/jsoneditor/css/jsoneditor.css" />
    <link rel="stylesheet" href="/app/admin/admin/css/reset.css" />
    <link rel="stylesheet" href="/app/admin/admin/css/dzh.css" />
    <style>
        /* 弹窗页面本身不滚动，只在 tab 内容区滚动 */
        html,
        body {
            height: 100%;
            overflow: hidden;
        }

        .mainBox {
            height: 100%;
            overflow: hidden;
        }

        .main-container {
            height: 100%;
            overflow: hidden;
        }

        /* 让 tabs 区域固定高度，内容滚动，但标题不滚动，且标题层级最高，避免被内容遮挡 */
        .layui-tabs {
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }

        .layui-tabs .layui-tabs-header {
            flex-shrink: 0;
            position: relative;
            z-index: 10;
            /* 提高层级，盖住下面的内容 */
            background-color: #fff;
        }

        .layui-tabs .layui-tabs-body {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0;
            padding: 10px 15px 80px;
            box-sizing: border-box;
            position: relative;
            z-index: 1;
        }

        /* 只在弹窗内部的 tabs 内容区里，重置子页面 mainBox 的高度，避免盖住 tab 头，导致无法切换 */
        .layui-tabs .layui-tabs-body .mainBox {
            height: auto;
            overflow: visible;
        }

        /* 同时重置子页面内部 main-container 的高度与滚动，让内容在 tabs-body 内滚动 */
        .layui-tabs .layui-tabs-body .main-container {
            height: auto;
            overflow: visible;
        }
        .bottom {
            z-index: 10; /* 提高层级，盖住下面的内容 */
        }
    </style>
</head>

<body>

    <form class="layui-form" action="" lay-filter="arctype-form">

        <div class="mainBox">
            <div class="main-container">
                <!-- Tabs 静态 HTML 结构 -->
                <div class="layui-tabs layui-tabs-card" lay-filter="arctype-tabs" lay-options="{index: 0}">
                    <ul class="layui-tabs-header">
                        <li lay-id="base">常规选项</li>
                        <li lay-id="advanced">高级选项</li>
                    </ul>
                    <div class="layui-tabs-body">
                        <div class="layui-tabs-item" id="tab-base"></div>
                        <div class="layui-tabs-item" id="tab-advanced"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bottom">
            <div class="button-container">
                <button type="submit" class="pear-btn pear-btn-primary pear-btn-md" lay-submit="" lay-filter="save">
                    提交
                </button>
                <button type="reset" class="pear-btn pear-btn-md">
                    重置
                </button>
            </div>
        </div>

    </form>

    <script src="/app/admin/component/layui/layui.js?v=2.13.12"></script>
    <script src="/app/admin/component/pear/pear.js"></script>
    <script src="/app/admin/component/jsoneditor/jsoneditor.js"></script>
    <script src="/app/admin/admin/js/permission.js"></script>

    <script>

        // 相关接口
        const PRIMARY_KEY = "id";
        const SELECT_API = "/app/admin/arctype/select" + location.search;
        const UPDATE_API = "/app/admin/arctype/update";
        const ARCTYPE_SELECT_API = "/app/admin/arctype/select";

        // 提交事件
        layui.use(["form", "layer", "pearPopup", "tabs", "jquery", "upload"], function () {
            var layer  = layui.layer;
            var tabs   = layui.tabs;
            var $      = layui.jquery;
            var form   = layui.form;
            var upload = layui.upload;

            /**
             * 将树形数据拍平成带缩进的下拉选项
             */
            function flattenTree(nodes, level = 0) {
                let list = [];
                nodes.forEach(function (node) {
                    const indent = level ? new Array(level).fill('　').join('') + '└ ' : '';
                    list.push({
                        id: node.id,
                        label: indent + node.name
                    });
                    if (node.children && node.children.length) {
                        list = list.concat(flattenTree(node.children, level + 1));
                    }
                });
                return list;
            }

            /**
             * 加载频道列表（模型列表）到下拉框
             * @param {Function} callback 加载完成后的回调函数
             */
            function loadChannelOptions(callback) {
                $.getJSON('/app/admin/channeltype/select', { format: 'select' }, function(res) {
                    if (res.code === 0 && Array.isArray(res.data)) {
                        var $select = $('#current-channel-select');
                        if ($select.length > 0) {
                            $select.empty().append('<option value="">请选择模型</option>');
                            res.data.forEach(function(item) {
                                $select.append('<option value="' + item.value + '">' + item.name + '</option>');
                            });
                            form.render('select');
                            if (typeof callback === 'function') {
                                callback();
                            }
                        }
                    } else {
                        console.error('加载频道列表失败:', res.msg);
                        if (typeof callback === 'function') {
                            callback();
                        }
                    }
                }).fail(function() {
                    console.error('加载频道列表请求失败');
                    if (typeof callback === 'function') {
                        callback();
                    }
                });
            }

            /**
             * 加载栏目树到"所属栏目"下拉框
             * 并根据当前记录的 parent_id 选中对应项
             * @param {number} currentParentId 当前记录的 parent_id，用于选中对应项
             * @param {Function} callback 加载完成后的回调函数
             */
            function loadParentOptionsAndSetValue(currentParentId, callback) {
                $.getJSON(ARCTYPE_SELECT_API, { format: 'tree', limit: 2000 }, function (res) {
                    if (res.code !== 0 || !Array.isArray(res.data)) {
                        layer.msg(res.msg || '栏目数据加载失败');
                        if (typeof callback === 'function') {
                            callback();
                        }
                        return;
                    }
                    var options = flattenTree(res.data);
                    var $select = $('select[name="parent_id"]');
                    $select.empty().append('<option value="0">顶级栏目</option>');
                    options.forEach(function (item) {
                        $select.append('<option value="' + item.id + '">' + item.label + '</option>');
                    });
                    if (currentParentId != null) {
                        $select.val(String(currentParentId));
                    }
                    form.render('select');
                    if (typeof callback === 'function') {
                        callback();
                    }
                }).fail(function () {
                    layer.msg('栏目数据请求异常');
                    if (typeof callback === 'function') {
                        callback();
                    }
                });
            }

            // 栏目图片上传
            function initUpload() {
                upload.render({
                    elem: '#upload-image',
                    url: '/app/admin/upload/image',
                    accept: 'image',
                    done: function (res) {
                        layer.msg('上传成功');
                        $('input[name="litpic"]').val(res.data.url);
                    },
                    error: function (res) {
                        layer.msg('上传失败');
                        console.log(res);
                    }
                });
            }


            // 1. 加载两个子页面的表单主体（只取 .mainBox .main-container，避免嵌套 form/html）
            $('#tab-base').load('/app/admin/arctype/base .mainBox', function () {
                form.render();
                
                // 先加载当前记录数据
                $.getJSON(SELECT_API, function (res) {
                    if (res.code !== 0 || !res.data || !res.data[0]) {
                        return;
                    }
                    var row = res.data[0];
                    
                    // 同步加载频道列表和栏目树，确保都加载完成后再填充表单数据
                    var channelLoaded = false;
                    var parentLoaded = false;
                    
                    function fillFormData() {
                        // 两个接口都加载完成后，再填充表单数据
                        if (channelLoaded && parentLoaded) {
                            // 普通字段自动回填
                            form.val("arctype-form", row);
                        }
                    }
                    
                    // 加载频道列表（模型列表）
                    loadChannelOptions(function() {
                        channelLoaded = true;
                        fillFormData();
                    });
                    
                    // 加载所属栏目下拉，并设置当前记录的 parent_id
                    loadParentOptionsAndSetValue(row.parent_id, function() {
                        parentLoaded = true;
                        fillFormData();
                    });
                });
            });
            $('#tab-advanced').load('/app/admin/arctype/advanced .mainBox', function () {
                form.render();
                // 高级选项 HTML 就绪后，初始化上传按钮
                initUpload();
            });

            // 2. tabs 切换事件（可选）
            tabs.on('change(arctype-tabs)', function (obj) {
                console.log('切换到 tab:', obj.id, '索引:', obj.index);
            });

            // 3. 字段验证允许为空
            form.verify({
                phone: [/(^$)|^1\d{10}$/, "请输入正确的手机号"],
                email: [/(^$)|^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/, "邮箱格式不正确"],
                url: [/(^$)|(^#)|(^http(s*):\/\/[^\s]+\.[^\s]+)/, "链接格式不正确"],
                number: [/(^$)|^\d+$/, '只能填写数字'],
                date: [/(^$)|^(\d{4})[-\/](\d{1}|0\d{1}|1[0-2])([-\/](\d{1}|0\d{1}|[1-2][0-9]|3[0-1]))*$/, "日期格式不正确"],
                identity: [/(^$)|(^\d{15}$)|(^\d{17}(x|X|\d)$)/, "请输入正确的身份证号"]
            });

            // 4. 表单提交事件
            form.on("submit(save)", function (data) {
                var formData = data.field;
                formData[PRIMARY_KEY] = layui.url().search[PRIMARY_KEY];
                console.log("formData", formData);

                layer.load();
                $.ajax({
                    url: UPDATE_API,
                    type: "POST",
                    dataType: "json",
                    data: formData,
                    success: function (res) {
                        layer.closeAll('pearLoading');
                        if (res.code) {
                            return layui.pearPopup.failure(res.msg);
                        }
                        return layui.pearPopup.success("操作成功", function () {
                            parent.refreshTable();
                            parent.layer.close(parent.layer.getFrameIndex(window.name));
                        });
                    },
                    error: function () {
                        layer.closeAll('pearLoading');
                        layui.pearPopup.failure("请求失败");
                    }
                });
                return false;
            });
        });

    </script>

</body>

</html>