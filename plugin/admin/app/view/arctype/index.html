<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8">
    <title>浏览页面</title>
    <link rel="stylesheet" href="/app/admin/component/pear/css/pear.css" />
    <link rel="stylesheet" href="/app/admin/admin/css/reset.css" />
</head>

<body class="pear-container">

    <!-- 顶部查询表单 -->
    <!-- <div class="layui-card">
            <div class="layui-card-body">
                <form class="layui-form top-search-from">
                    
                    <div class="layui-form-item">
                        <label class="layui-form-label">主键</label>
                        <div class="layui-input-block">
                            <input type="number" name="id" value="" class="layui-input">
                        </div>
                    </div>
                    
                    <div class="layui-form-item">
                        <label class="layui-form-label">创建时间</label>
                        <div class="layui-input-block">
                            <div class="layui-input-block" id="created_at">
                                <input type="text" autocomplete="off" name="created_at[]" id="created_at-date-start" class="layui-input inline-block" placeholder="开始时间">
                                -
                                <input type="text" autocomplete="off" name="created_at[]" id="created_at-date-end" class="layui-input inline-block" placeholder="结束时间">
                            </div>
                        </div>
                    </div>
                    
                    <div class="layui-form-item layui-inline">
                        <label class="layui-form-label"></label>
                        <button class="pear-btn pear-btn-md pear-btn-primary" lay-submit lay-filter="table-query">
                            <i class="layui-icon layui-icon-search"></i>查询
                        </button>
                        <button type="reset" class="pear-btn pear-btn-md" lay-submit lay-filter="table-reset">
                            <i class="layui-icon layui-icon-refresh"></i>重置
                        </button>
                    </div>
                    <div class="toggle-btn">
                        <a class="layui-hide">展开<i class="layui-icon layui-icon-down"></i></a>
                        <a class="layui-hide">收起<i class="layui-icon layui-icon-up"></i></a>
                    </div>
                </form>
            </div>
        </div> -->

    <!-- 数据表格 -->
    <div class="layui-card">
        <div class="layui-card-body">
            <table id="data-table" lay-filter="data-table"></table>
        </div>
    </div>

    <!-- 表格顶部工具栏 -->
    <script type="text/html" id="table-toolbar">
        <button class="pear-btn pear-btn-primary pear-btn-md" lay-event="add" permission="app.admin.arctype.insert">
            <i class="layui-icon layui-icon-add-1"></i>新增
        </button>
        <button class="pear-btn pear-btn-danger pear-btn-md" lay-event="batchRemove" permission="app.admin.arctype.delete">
            <i class="layui-icon layui-icon-delete"></i>删除
        </button>
        <button class="pear-btn pear-btn-success pear-btn-md" lay-event="expandAll">
            <i class="layui-icon layui-icon-spread-left"></i>
            展开
        </button>
        <button class="pear-btn pear-btn-success pear-btn-md" lay-event="foldAll">
            <i class="layui-icon layui-icon-shrink-right"></i>
            折叠
        </button>
    </script>

    <!-- 表格行工具栏 -->
    <script type="text/html" id="table-bar">
        <button class="pear-btn pear-btn-xs tool-btn" lay-event="remove" permission="app.admin.arctype.delete">内容 |</button>
        <button class="pear-btn pear-btn-xs tool-btn" lay-event="edit" permission="app.admin.arctype.update">编辑 |</button>
        <button class="pear-btn pear-btn-xs tool-btn" lay-event="add" permission="app.admin.arctype.insert">增加子栏目 |</button>
        <button class="pear-btn pear-btn-xs tool-btn" lay-event="preview" permission="app.admin.arctype.preview">预览 |</button>
        <button class="pear-btn pear-btn-xs tool-btn" lay-event="remove" permission="app.admin.arctype.delete">删除 |</button>
    </script>

    <script src="/app/admin/component/layui/layui.js?v=2.8.12"></script>
    <script src="/app/admin/component/pear/pear.js"></script>
    <script src="/app/admin/admin/js/permission.js"></script>
    <script src="/app/admin/admin/js/common.js"></script>

    <script>

        // 相关常量
        const PRIMARY_KEY = "id";
        const SELECT_API = "/app/admin/arctype/select";
        const UPDATE_API = "/app/admin/arctype/update";
        const DELETE_API = "/app/admin/arctype/delete";
        const INSERT_URL = "/app/admin/arctype/insert";
        const UPDATE_URL = "/app/admin/arctype/update";

        // 字段 创建时间 created_at
        layui.use(["laydate"], function () {
            layui.laydate.render({
                elem: "#created_at",
                range: ["#created_at-date-start", "#created_at-date-end"],
                type: "datetime",
            });
        })

        // 表格渲染
        layui.use(["table", "form", "common", "popup", "util", "treetable"], function () {
            let table = layui.table;
            let form = layui.form;
            let $ = layui.$;
            let common = layui.common;
            let util = layui.util;
            let treetable = layui.treetable;

            // 表头参数
            let cols = [
                {
                    type: "checkbox",
                    align: "center"
                }, {
                    title: "ID", align: "center",
                    field: "id",
                    // sort: true,
                },
                {
                    title: "+栏目名称", align: "center",
                    field: "typename",
                },
                {
                    title: "模型", align: "center",
                    field: "current_channel",
                },
                {
                    title: "显示", align: "center",
                    field: "is_hidden",
                },
                {
                    title: "操作",
                    toolbar: "#table-bar",
                    align: "center",
                    fixed: "right",
                    width: 120,
                },
                {
                    title: "排序", align: "center",
                    field: "sort_order",
                },


                // {
                // 	title: "创建时间",align: "center",
                // 	field: "created_at",
                // 	sort: true,
                // },{
                // 	title: "更新时间",align: "center",
                // 	field: "updated_at",
                // },{
                // 	title: "栏目顶级模型ID",align: "center",
                // 	field: "channeltype",
                // },{
                // 	title: "栏目上级ID",align: "center",
                // 	field: "parent_id",
                // },{
                // 	title: "顶级栏目ID",align: "center",
                // 	field: "topid",
                // },
                // {
                // 	title: "目录英文名",align: "center",
                // 	field: "dirname",
                // },{
                // 	title: "目录存放HTML路径",align: "center",
                // 	field: "dirpath",
                // },{
                // 	title: "列表静态文件存放规则",align: "center",
                // 	field: "diy_dirpath",
                // },{
                // 	title: "列表静态文件存放规则",align: "center",
                // 	field: "rulelist",
                // },{
                // 	title: "文档静态文件存放规则",align: "center",
                // 	field: "ruleview",
                // },{
                // 	title: "栏目英文名",align: "center",
                // 	field: "englist_name",
                // },{
                // 	title: "栏目等级",align: "center",
                // 	field: "grade",
                // },{
                // 	title: "栏目链接",align: "center",
                // 	field: "typelink",
                // },{
                // 	title: "栏目图片",align: "center",
                // 	field: "litpic",
                // },{
                // 	title: "列表模板文件名",align: "center",
                // 	field: "templist",
                // },{
                // 	title: "文档模板文件名",align: "center",
                // 	field: "tempview",
                // },{
                // 	title: "SEO标题",align: "center",
                // 	field: "seo_title",
                // },{
                // 	title: "seo关键字",align: "center",
                // 	field: "seo_keywords",
                // },{
                // 	title: "seo描述",align: "center",
                // 	field: "seo_description",
                // },{
                // 	title: "栏目属性：0=内容栏目，1=外部链接",align: "center",
                // 	field: "is_part",
                // },{
                // 	title: "管理员ID",align: "center",
                // 	field: "admin_id",
                // },{
                // 	title: "伪删除，1=是，0=否",align: "center",
                // 	field: "is_del",
                // },{
                // 	title: "伪删除状态，1为主动删除，2为跟随上级栏目被动删除",align: "center",
                // 	field: "del_method",
                // },{
                // 	title: "启用 (1=正常，0=屏蔽)",align: "center",
                // 	field: "status",
                // },{
                // 	title: "栏目是否应用于会员投稿发布，1是，0否",align: "center",
                // 	field: "is_release",
                // },{
                // 	title: "插件栏目唯一标识",align: "center",
                // 	field: "weapp_code",
                // },{
                // 	title: "语言标识",align: "center",
                // 	field: "lang",
                // },{
                // 	title: "新增时间",align: "center",
                // 	field: "add_time",
                // },{
                // 	title: "更新时间",align: "center",
                // 	field: "update_time",
                // },{
                // 	title: "新窗口打开",align: "center",
                // 	field: "target",
                // },{
                // 	title: "防抓取",align: "center",
                // 	field: "nofollow",
                // },{
                // 	title: "阅读权限：0=开放浏览，-1=待审核稿件",align: "center",
                // 	field: "typearcrank",
                // },{
                // 	title: "空内容逻辑",align: "center",
                // 	field: "empty_logic",
                // },{
                // 	title: "限制页面 1-栏目页面 0-文档页面",align: "center",
                // 	field: "page_limit",
                // },{
                // 	title: "栏目下文档数量",align: "center",
                // 	field: "total_arc",
                // }
            ];

            // 渲染表格
            // trtableeetable.render({
            //     elem: "#data-table",
            //     url: SELECT_API,
            //     page: true,
            //     cols: [cols],
            //     skin: "line",
            //     size: "lg",
            //     toolbar: "#table-toolbar",
            //     autoSort: false,
            //     defaultToolbar: [{
            //         title: "刷新",
            //         layEvent: "refresh",
            //         icon: "layui-icon-refresh",
            //     }, "filter", "print", "exports"],
            //     done: function () {
            //         layer.photos({photos: 'div[lay-id="data-table"]', anim: 5});
            //     }
            // });


            treetable.render({
                treeColIndex: 1,
                treeIdName: 'powerId',
                treePidName: 'parentId',
                skin: 'line',
                treeDefaultClose: true,
                toolbar: '#table-toolbar',
                elem: '#data-table',
                url: SELECT_API,
                page: false,
                cols: [cols],
            });



            // 编辑或删除行事件
            table.on("tool(data-table)", function (obj) {
                if (obj.event === "remove") {
                    remove(obj);
                } else if (obj.event === "edit") {
                    edit(obj);
                }
            });

            // 表格顶部工具栏事件
            table.on("toolbar(data-table)", function (obj) {
                if (obj.event === "add") {
                    add();
                } else if (obj.event === "refresh") {
                    refreshTable();
                } else if (obj.event === "batchRemove") {
                    batchRemove(obj);
                }
            });

            // 表格顶部搜索事件
            form.on("submit(table-query)", function (data) {
                table.reload("data-table", {
                    page: {
                        curr: 1
                    },
                    where: data.field
                })
                return false;
            });

            // 表格顶部搜索重置事件
            form.on("submit(table-reset)", function (data) {
                table.reload("data-table", {
                    where: []
                })
            });

            // 字段允许为空
            form.verify({
                phone: [/(^$)|^1\d{10}$/, "请输入正确的手机号"],
                email: [/(^$)|^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/, "邮箱格式不正确"],
                url: [/(^$)|(^#)|(^http(s*):\/\/[^\s]+\.[^\s]+)/, "链接格式不正确"],
                number: [/(^$)|^\d+$/, '只能填写数字'],
                date: [/(^$)|^(\d{4})[-\/](\d{1}|0\d{1}|1[0-2])([-\/](\d{1}|0\d{1}|[1-2][0-9]|3[0-1]))*$/, "日期格式不正确"],
                identity: [/(^$)|(^\d{15}$)|(^\d{17}(x|X|\d)$)/, "请输入正确的身份证号"]
            });

            // 表格排序事件
            table.on("sort(data-table)", function (obj) {
                table.reload("data-table", {
                    initSort: obj,
                    scrollPos: "fixed",
                    where: {
                        field: obj.field,
                        order: obj.type
                    }
                });
            });

            // 表格新增数据
            let add = function () {
                layer.open({
                    type: 2,
                    title: "新增",
                    shade: 0.1,
                    maxmin: true,
                    area: [common.isModile() ? "100%" : "800px", common.isModile() ? "100%" : "800px"],
                    content: INSERT_URL
                });
            }

            // 表格编辑数据
            let edit = function (obj) {
                let value = obj.data[PRIMARY_KEY];
                layer.open({
                    type: 2,
                    title: "修改",
                    shade: 0.1,
                    maxmin: true,
                    area: [common.isModile() ? "100%" : "800px", common.isModile() ? "100%" : "800px"],
                    content: UPDATE_URL + "?" + PRIMARY_KEY + "=" + value
                });
            }

            // 删除一行
            let remove = function (obj) {
                return doRemove(obj.data[PRIMARY_KEY]);
            }

            // 删除多行
            let batchRemove = function (obj) {
                let checkIds = common.checkField(obj, PRIMARY_KEY);
                if (checkIds === "") {
                    layui.popup.warning("未选中数据");
                    return false;
                }
                doRemove(checkIds.split(","));
            }

            // 执行删除
            let doRemove = function (ids) {
                let data = {};
                data[PRIMARY_KEY] = ids;
                layer.confirm("确定删除?", {
                    icon: 3,
                    title: "提示"
                }, function (index) {
                    layer.close(index);
                    let loading = layer.load();
                    $.ajax({
                        url: DELETE_API,
                        data: data,
                        dataType: "json",
                        type: "post",
                        success: function (res) {
                            layer.close(loading);
                            if (res.code) {
                                return layui.popup.failure(res.msg);
                            }
                            return layui.popup.success("操作成功", refreshTable);
                        }
                    })
                });
            }

            // 刷新表格数据
            window.refreshTable = function () {
                table.reloadData("data-table", {
                    scrollPos: "fixed",
                    done: function (res, curr) {
                        if (curr > 1 && res.data && !res.data.length) {
                            curr = curr - 1;
                            table.reloadData("data-table", {
                                page: {
                                    curr: curr
                                },
                            })
                        }
                    }
                });
            }
        })

    </script>
</body>

</html>