<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8">
    <title>浏览页面</title>
    <link rel="stylesheet" href="/app/admin/component/pear/css/pear.css" />
    <link rel="stylesheet" href="/app/admin/admin/css/reset.css" />
    <link rel="stylesheet" href="/app/admin/admin/css/dzh.css" />
 
</head>

<body class="pear-container">

 
    <!-- 数据表格 -->
    <div class="layui-card">
        <div class="layui-card-body">
            <table id="data-table" lay-filter="data-table"></table>
        </div>
    </div>

    <!-- 表格顶部工具栏 -->
    <script type="text/html" id="table-toolbar">
        <button class="pear-btn pear-btn-primary pear-btn-xs" lay-event="add" permission="app.admin.arctype.insert">
            <i class="layui-icon layui-icon-add-1"></i>新增
        </button>
        <button class="pear-btn pear-btn-danger pear-btn-xs" lay-event="batchRemove" permission="app.admin.arctype.delete">
            <i class="layui-icon layui-icon-delete"></i>删除
        </button>
        <button class="pear-btn pear-btn-success pear-btn-xs" id="expand-fold-btn" lay-event="expandFold">
            <i class="layui-icon layui-icon-spread-left"></i><span class="btn-text">展开</span>
        </button>
    </script>

    <!-- 表格行工具栏 -->
    <script type="text/html" id="table-bar">
        <span class="pear-text pear-text-primary" lay-event="content" permission="app.admin.arctype.delete">内容 |</span>
        <span class="pear-text pear-text-primary" lay-event="edit" permission="app.admin.arctype.update">编辑 |</span>
        <span class="pear-text pear-text-primary" lay-event="addSub" permission="app.admin.arctype.insert">增加子栏目 |</span>
        <span class="pear-text pear-text-primary" lay-event="preview" permission="app.admin.arctype.preview">预览 |</span>
        <span class="pear-text pear-text-danger" lay-event="remove" permission="app.admin.arctype.delete">删除</span>
    </script>

 
    <script src="/app/admin/component/layui/layui.js?v=2.13.12"></script>
    <script src="/app/admin/component/pear/pear.js"></script>
    <script src="/app/admin/admin/js/permission.js"></script>
    <script src="/app/admin/admin/js/common.js"></script>

    <script>

        // 相关常量
        const PRIMARY_KEY = "id";
        const SELECT_API = "/app/admin/arctype/select";
        const UPDATE_API = "/app/admin/arctype/update";
        const DELETE_API = "/app/admin/arctype/delete";
        const INSERT_URL = "/app/admin/arctype/insert";
        const UPDATE_URL = "/app/admin/arctype/update";

        // 字段 创建时间 created_at
        layui.use(["laydate"], function () {
            layui.laydate.render({
                elem: "#created_at",
                range: ["#created_at-date-start", "#created_at-date-end"],
                type: "datetime",
            });
        })

        // 表格渲染
        layui.use(["table", "form", "pearCommon", "pearPopup", "util", "pearTreetable"], function () {
            let table = layui.table;
            let form = layui.form;
            let $ = layui.$;
            let common = layui.pearCommon;
            let util = layui.util;
            let treetable = layui.pearTreetable;
            
            // 树形表格展开/折叠状态（true=展开，false=折叠）
            let isExpanded = false; // 初始状态为折叠（因为 treeDefaultClose: true）
            
            // 更新展开/折叠按钮显示
            function updateExpandFoldButton(expanded) {
                var $btn = $('#expand-fold-btn');
                var $icon = $btn.find('i');
                var $text = $btn.find('.btn-text');
                if (expanded) {
                    $icon.removeClass('layui-icon-spread-left').addClass('layui-icon-shrink-right');
                    $text.text('折叠');
                } else {
                    $icon.removeClass('layui-icon-shrink-right').addClass('layui-icon-spread-left');
                    $text.text('展开');
                }
            }

            // 表头参数
            let cols = [
                {
                    type: "checkbox",
                    align: "center"
                },
                {
                    title: "ID", align: "center",
                    field: "id",
                    width: 50,
                },
                {
                    title: "栏目名称", align: "left",
                    field: "typename",
                },
                {
                    title: "模型", align: "center",
                    field: "channel_name",
                    width: 100,
                },
                {
                    title: "显示", align: "center",
                    field: "is_hidden",
                    templet: function (d) {
                        const isShow = d.is_hidden == 0;
                        const cls = isShow ? "status-show" : "status-hide";
                        const icon = isShow ? "layui-icon-ok-circle" : "layui-icon-close-fill";
                        const text = isShow ? "是" : "否";
                        const val = isShow ? "0" : "1";
                        return '<span class="status-badge ' + cls + '" data-id="' + util.escape(d.id) + '" data-field="is_hidden" data-value="' + val + '"><i class="layui-icon ' + icon + '"></i>' + text + '</span>';
                    },
                    width: 80,
                },
                {
                    title: "排序", align: "center",
                    field: "sort_order",
                    width: 80,
                    templet: function (d) {
                        return '<span class="sort-order-cell" data-id="' + d.id + '" data-value="' + (d.sort_order || 0) + '" style="cursor:pointer;padding:5px;display:inline-block;min-width:40px;">' + (d.sort_order || 0) + '</span>';
                    }
                },
                {
                    title: "操作",
                    templet: "#table-bar",
                    align: "center",
                    fixed: "right",
                    width: 250,
                },


            ];


            treetable.render({
                treeColIndex: 2,
                treeIdName: 'id',
                treePidName: 'parent_id',
                skin: 'line',
                treeDefaultClose: true,
                toolbar: '#table-toolbar',
                elem: '#data-table',
                url: SELECT_API,
                page: false,
                cols: [cols],
                defaultToolbar: [{
                    title: "刷新",
                    layEvent: "refresh",
                    icon: "layui-icon-refresh",
                }, "filter", "print", "exports"],
                // 单击编辑回调
                onEdit: function (obj) {
                    var id = obj.data.id;
                    var field = obj.field;
                    var value = obj.value;

                    // 更新到数据库
                    updateField(id, field, value, function () {
                        layer.msg('更新成功', { icon: 1, time: 1000 });
                    });
                }
            });



            // 编辑或删除行事件
            table.on("tool(data-table)", function (obj) {
                if (obj.event === "remove") {
                    remove(obj);
                } else if (obj.event === "edit") {
                    edit(obj);
                } else if (obj.event === "addSub") {
                    addSub(obj);
                }
            });

            // 表格顶部工具栏事件
            table.on("toolbar(data-table)", function (obj) {
                if (obj.event === "add") {
                    add();
                } else if (obj.event === "refresh") {
                    refreshTable();
                } else if (obj.event === "batchRemove") {
                    batchRemove(obj);
                } else if (obj.event === "expandFold") {
                    // 切换展开/折叠状态
                    if (isExpanded) {
                        treetable.foldAll("#data-table");
                        isExpanded = false;
                        updateExpandFoldButton(false);
                    } else {
                        treetable.expandAll("#data-table");
                        isExpanded = true;
                        updateExpandFoldButton(true);
                    }
                }
            });

            // 表格顶部搜索事件
            form.on("submit(table-query)", function (data) {
                var keyword = data.field.keyword;
                treetable.search('#data-table', keyword);
                return false;
            });

            // 表格顶部搜索重置事件
            form.on("submit(table-reset)", function (data) {
                treetable.reload("#data-table");
            });

            // 字段允许为空
            form.verify({
                phone: [/(^$)|^1\d{10}$/, "请输入正确的手机号"],
                email: [/(^$)|^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/, "邮箱格式不正确"],
                url: [/(^$)|(^#)|(^http(s*):\/\/[^\s]+\.[^\s]+)/, "链接格式不正确"],
                number: [/(^$)|^\d+$/, '只能填写数字'],
                date: [/(^$)|^(\d{4})[-\/](\d{1}|0\d{1}|1[0-2])([-\/](\d{1}|0\d{1}|[1-2][0-9]|3[0-1]))*$/, "日期格式不正确"],
                identity: [/(^$)|(^\d{15}$)|(^\d{17}(x|X|\d)$)/, "请输入正确的身份证号"]
            });

            // 表格排序事件
            table.on("sort(data-table)", function (obj) {
                table.reload("data-table", {
                    initSort: obj,
                    scrollPos: "fixed",
                    where: {
                        field: obj.field,
                        order: obj.type
                    }
                });
            });

            // 表格新增数据
            let add = function () {
                layer.open({
                    type: 2,
                    title: "新增",
                    shade: 0.1,
                    maxmin: true,
                    area: [common.isModile() ? "100%" : "700px", common.isModile() ? "100%" : "90%"],
                    content: INSERT_URL
                });
            }

            // 表格编辑数据
            let edit = function (obj) {
                let value = obj.data[PRIMARY_KEY];
                layer.open({
                    type: 2,
                    title: "修改",
                    shade: 0.1,
                    maxmin: true,
                    area: [common.isModile() ? "100%" : "700px", common.isModile() ? "100%" : "90%"],
                    content: UPDATE_URL + "?" + PRIMARY_KEY + "=" + value
                });
            }

            // 增加子栏目
            let addSub = function (obj) {
                let parentId = obj.data[PRIMARY_KEY];
                layer.open({
                    type: 2,
                    title: "增加子栏目",
                    shade: 0.1,
                    maxmin: true,
                    area: [common.isModile() ? "100%" : "700px", common.isModile() ? "100%" : "90%"],
                    content: INSERT_URL + "?parent_id=" + parentId
                });
            }

            // 删除一行
            let remove = function (obj) {
                return doRemove(obj.data[PRIMARY_KEY]);
            }

            // 删除多行
            let batchRemove = function (obj) {
                let checkIds = common.checkField(obj, PRIMARY_KEY);
                if (checkIds === "") {
                    layui.pearPopup.warning("未选中数据");
                    return false;
                }
                doRemove(checkIds.split(","));
            }

            // 执行删除
            let doRemove = function (ids) {
                let data = {};
                data[PRIMARY_KEY] = ids;
                layer.confirm("确认直接删除？子栏目及文档将一起清空。", {
                    icon: 3,
                    title: "提示"
                }, function (index) {
                    layer.close(index);
                    let loading = layer.load();
                    $.ajax({
                        url: DELETE_API,
                        data: data,
                        dataType: "json",
                        type: "post",
                        success: function (res) {
                            layer.close(loading);
                            if (res.code) {
                                return layui.pearPopup.failure(res.msg);
                            }
                            return layui.pearPopup.success("操作成功", refreshTable);
                        }
                    })
                });
            }

            // 刷新表格数据
            window.refreshTable = function () {
                // 保存当前展开状态
                var wasExpanded = isExpanded;
                
                // 重新加载表格
                treetable.reload("#data-table");
                
                // 重新加载完成后，恢复展开状态
                // 使用 setTimeout 确保表格渲染完成后再执行展开操作
                setTimeout(function() {
                    if (wasExpanded) {
                        treetable.expandAll("#data-table");
                        isExpanded = true;
                        updateExpandFoldButton(true);
                    } else {
                        isExpanded = false;
                        updateExpandFoldButton(false);
                    }
                }, 50);
            }

            // 更新字段到数据库
            function updateField(id, field, value, callback) {
                let data = {};
                data[PRIMARY_KEY] = id;
                data[field] = value;
                $.ajax({
                    url: UPDATE_API,
                    type: "POST",
                    dataType: "json",
                    data: data,
                    success: function (res) {
                        if (res.code) {
                            layui.pearPopup.failure(res.msg);
                            return;
                        }
                        if (callback) callback();
                    },
                    error: function () {
                        layui.pearPopup.failure("请求失败");
                    }
                });
            }

            // 更新排序
            function updateSortOrder(id, sortOrder, successCallback, errorCallback) {
                updateField(id, 'sort_order', sortOrder, function() {
                    if (successCallback) successCallback();
                });
            }

            // 双击编辑排序
            $(document).on('dblclick', '.sort-order-cell', function(e) {
                e.stopPropagation(); // 阻止事件冒泡，避免触发其他事件
                var $this = $(this);
                var id = $this.data('id');
                var oldValue = $this.data('value') || 0;
                // 保存原始样式
                var originalStyle = $this.attr('style') || '';
                var $input = $('<input type="number" class="layui-input" value="' + oldValue + '" style="width:80px;text-align:center;margin:0;border:1px solid #e6e6e6;height:28px;line-height:28px;padding:0 5px;">');
                $this.html($input);
                $input.focus().select();
                
                $input.on('blur', function() {
                    var newValue = parseInt($(this).val()) || 0;
                    updateSortOrder(id, newValue, function() {
                        $this.data('value', newValue);
                        // 恢复原始样式并设置新值
                        $this.attr('style', originalStyle);
                        $this.text(newValue);
                        layer.msg('更新成功', { icon: 1, time: 1000 });
                    }, function() {
                        // 恢复原始样式和旧值
                        $this.attr('style', originalStyle);
                        $this.text(oldValue);
                    });
                });
                
                $input.on('keydown', function(e) {
                    e.stopPropagation(); // 阻止事件冒泡
                    if (e.keyCode === 13) { // Enter
                        $(this).blur();
                    } else if (e.keyCode === 27) { // ESC
                        // 恢复原始样式和旧值
                        $this.attr('style', originalStyle);
                        $this.text(oldValue);
                    }
                });
            });

            // 点击切换显示/隐藏状态
            $(document).on('click', '.status-badge', function () {
                var $this = $(this);
                var id = $this.data('id');
                var currentValue = parseInt($this.data('value'));
                var newValue = currentValue === 0 ? 1 : 0;

                updateField(id, 'is_hidden', newValue, function () {
                    // 更新UI - 只改变类名和属性
                    $this.data('value', newValue);
                    var $icon = $this.find('.layui-icon');
                    if (newValue === 0) {
                        $this.removeClass('status-hide').addClass('status-show');
                        $icon.removeClass('layui-icon-close-fill').addClass('layui-icon-ok-circle');
                        $icon[0].nextSibling.nodeValue = '是';
                    } else {
                        $this.removeClass('status-show').addClass('status-hide');
                        $icon.removeClass('layui-icon-ok-circle').addClass('layui-icon-close-fill');
                        $icon[0].nextSibling.nodeValue = '否';
                    }
                    layer.msg('更新成功', { icon: 1, time: 1000 });
                });
            });

        })

    </script>
</body>

</html>