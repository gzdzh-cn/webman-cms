<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8">
    <title>浏览页面</title>
    <link rel="stylesheet" href="/app/admin/component/pear/css/pear.css" />
    <link rel="stylesheet" href="/app/admin/admin/css/reset.css" />
    <link rel="stylesheet" href="/app/admin/admin/css/dzh.css" />
</head>

<body class="pear-container">

    <!-- 数据表格 -->
    <div class="layui-card">
        <div class="layui-card-body">
            <table id="data-table" lay-filter="data-table"></table>
        </div>
    </div>

    <!-- 表格顶部工具栏 -->
    <script type="text/html" id="table-toolbar">
        <button class="pear-btn pear-btn-primary pear-btn-xs" lay-event="add" permission="app.admin.channeltype.insert">
            <i class="layui-icon layui-icon-add-1"></i>新增
        </button>
        <button class="pear-btn pear-btn-danger pear-btn-xs" lay-event="batchRemove" permission="app.admin.channeltype.delete">
            <i class="layui-icon layui-icon-delete"></i>删除
        </button>
    </script>

    <!-- 表格行工具栏 -->
    <script type="text/html" id="table-bar">
        <button class="pear-btn pear-btn-xs tool-btn pear-text" lay-event="fieldSelect" permission="app.admin.channelfield.index">字段</button>
        <button class="pear-btn pear-btn-xs tool-btn pear-text" lay-event="edit" permission="app.admin.channeltype.update">编辑</button>
        <button class="pear-btn pear-btn-xs tool-btn pear-text" lay-event="remove" permission="app.admin.channeltype.delete">删除</button>
    </script>


    <script src="/app/admin/component/layui/layui.js?v=2.13.12"></script>
    <script src="/app/admin/component/pear/pear.js"></script>
    <script src="/app/admin/admin/js/permission.js"></script>
    <script src="/app/admin/admin/js/common.js"></script>

    <script>

        // 相关常量
        const PRIMARY_KEY = "id";
        const SELECT_API = "/app/admin/channeltype/select";
        const UPDATE_API = "/app/admin/channeltype/update";
        const DELETE_API = "/app/admin/channeltype/delete";
        const INSERT_URL = "/app/admin/channeltype/insert";
        const UPDATE_URL = "/app/admin/channeltype/update";

        // 字段 创建时间 created_at
        layui.use(["laydate"], function () {
            layui.laydate.render({
                elem: "#created_at",
                range: ["#created_at-date-start", "#created_at-date-end"],
                type: "datetime",
            });
        })

        // 表格渲染
        layui.use(["table", "form", "pearCommon", "pearPopup", "util"], function () {
            let table = layui.table;
            let form = layui.form;
            let $ = layui.$;
            let common = layui.pearCommon;
            let util = layui.util;

            // 表头参数
            let cols = [
                {
                    type: "checkbox",
                    align: "center"
                }, {
                    title: "ID", align: "center",
                    field: "id",
                    width: 50,
                }, {
                    title: "模型名称", align: "left",
                    field: "title",
                }, {
                    title: "模型标识", align: "center",
                    field: "nid",
                    width: 100,
                }, {
                    title: "字段数", align: "center",
                    field: "field_count",
                    width: 80,
                }, {
                    title: "启用", align: "center",
                    field: "status",
                    templet: function (d) {
                        const isShow = d.status == 1;
                        const cls = isShow ? "status-show" : "status-hide";
                        const icon = isShow ? "layui-icon-ok-circle" : "layui-icon-close-fill";
                        const text = isShow ? "是" : "否";
                        const val = d.status || 0;
                        return '<span class="status-badge ' + cls + '" data-id="' + util.escape(d.id) + '" data-field="status" data-value="' + val + '"><i class="layui-icon ' + icon + '"></i>' + text + '</span>';
                    },
                    width: 80,
                }, {
                    title: "操作",
                    toolbar: "#table-bar",
                    align: "center",
                    fixed: "right",
                    width: 250,
                }
            ];

            // 渲染表格
            table.render({
                elem: "#data-table",
                url: SELECT_API,
                page: false,
                cols: [cols],
                skin: "line",
                size: "lg",
                toolbar: "#table-toolbar",
                autoSort: false,
                where: {
                    limit: 100
                },
                defaultToolbar: [{
                    title: "刷新",
                    layEvent: "refresh",
                    icon: "layui-icon-refresh",
                }, "filter", "print", "exports"],
                done: function () {
                    layer.photos({ photos: 'div[lay-id="data-table"]', anim: 5 });
                }
            });


            // 编辑或删除行事件
            table.on("tool(data-table)", function (obj) {
                if (obj.event === "remove") {
                    remove(obj);
                } else if (obj.event === "edit") {
                    edit(obj);
                } else if (obj.event === "fieldSelect") {
                    fieldSelect(obj);
                }
            });

            // 表格顶部工具栏事件
            table.on("toolbar(data-table)", function (obj) {
                if (obj.event === "add") {
                    add();
                } else if (obj.event === "refresh") {
                    refreshTable();
                } else if (obj.event === "batchRemove") {
                    batchRemove(obj);
                }
            });

            // 表格顶部搜索事件
            form.on("submit(table-query)", function (data) {
                table.reload("data-table", {
                    page: {
                        curr: 1
                    },
                    where: data.field
                })
                return false;
            });

            // 表格顶部搜索重置事件
            form.on("submit(table-reset)", function (data) {
                table.reload("data-table", {
                    where: []
                })
            });

            // 字段允许为空
            form.verify({
                phone: [/(^$)|^1\d{10}$/, "请输入正确的手机号"],
                email: [/(^$)|^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/, "邮箱格式不正确"],
                url: [/(^$)|(^#)|(^http(s*):\/\/[^\s]+\.[^\s]+)/, "链接格式不正确"],
                number: [/(^$)|^\d+$/, '只能填写数字'],
                date: [/(^$)|^(\d{4})[-\/](\d{1}|0\d{1}|1[0-2])([-\/](\d{1}|0\d{1}|[1-2][0-9]|3[0-1]))*$/, "日期格式不正确"],
                identity: [/(^$)|(^\d{15}$)|(^\d{17}(x|X|\d)$)/, "请输入正确的身份证号"]
            });

            // 表格排序事件
            table.on("sort(data-table)", function (obj) {
                table.reload("data-table", {
                    initSort: obj,
                    scrollPos: "fixed",
                    where: {
                        field: obj.field,
                        order: obj.type
                    }
                });
            });

            // 表格新增数据
            let add = function () {
                layer.open({
                    type: 2,
                    title: "新增",
                    shade: 0.1,
                    maxmin: true,
                    area: [common.isModile() ? "100%" : "700px", common.isModile() ? "100%" : "700px"],
                    content: INSERT_URL
                });
            }

            // 表格编辑数据
            let edit = function (obj) {
                console.log(obj);
                let value = obj.data[PRIMARY_KEY];
                layer.open({
                    type: 2,
                    title: "修改",
                    shade: 0.1,
                    maxmin: true,
                    area: [common.isModile() ? "100%" : "700px", common.isModile() ? "100%" : "700px"],
                    content: UPDATE_URL + "?" + PRIMARY_KEY + "=" + value
                });
            }

            // 字段管理
            let fieldSelect = function (obj) {
                let channelId = obj.data[PRIMARY_KEY];
                layer.open({
                    type: 2,
                    title: "字段管理 - " + (obj.data.title || ""),
                    shade: 0.1,
                    maxmin: true,
                    area: [common.isModile() ? "100%" : "100%", common.isModile() ? "100%" : "100%"],
                    content: "/app/admin/channelfield/index?channel_id=" + channelId
                });
            }

            // 删除一行
            let remove = function (obj) {
                return doRemove(obj.data[PRIMARY_KEY]);
            }

            // 删除多行
            let batchRemove = function (obj) {
                let checkIds = common.checkField(obj, PRIMARY_KEY);
                if (checkIds === "") {
                    layui.pearPopup.warning("未选中数据");
                    return false;
                }
                doRemove(checkIds.split(","));
            }

            // 执行删除
            let doRemove = function (ids) {
                let data = {};
                data[PRIMARY_KEY] = ids;
                layer.confirm("确定删除?", {
                    icon: 3,
                    title: "提示"
                }, function (index) {
                    layer.close(index);
                    let loading = layer.load();
                    $.ajax({
                        url: DELETE_API,
                        data: data,
                        dataType: "json",
                        type: "post",
                        success: function (res) {
                            layer.close(loading);
                            if (res.code) {
                                return layui.pearPopup.failure(res.msg);
                            }
                            return layui.pearPopup.success("操作成功", refreshTable);
                        }
                    })
                });
            }

            // 刷新表格数据
            window.refreshTable = function () {
                table.reloadData("data-table", {
                    scrollPos: "fixed",
                    done: function (res, curr) {
                        if (curr > 1 && res.data && !res.data.length) {
                            curr = curr - 1;
                            table.reloadData("data-table", {
                                page: {
                                    curr: curr
                                },
                            })
                        }
                    }
                });
            }


            // 更新字段到数据库
            function updateField(id, field, value, callback) {
                let data = {};
                data[PRIMARY_KEY] = id;
                data[field] = value;
                $.ajax({
                    url: UPDATE_API,
                    type: "POST",
                    dataType: "json",
                    data: data,
                    success: function (res) {
                        if (res.code) {
                            layui.pearPopup.failure(res.msg);
                            return;
                        }
                        if (callback) callback();
                    },
                    error: function () {
                        layui.pearPopup.failure("请求失败");
                    }
                });
            }

            // 点击切换启用/禁用状态
            $(document).on('click', '.status-badge', function () {
                var $this = $(this);
                var id = $this.data('id');
                var field = $this.data('field');
                var currentValue = parseInt($this.data('value')) || 0;
                var newValue = currentValue === 1 ? 0 : 1;

                updateField(id, field, newValue, function () {
                    // 更新UI - 只改变类名和属性
                    $this.data('value', newValue);
                    var $icon = $this.find('.layui-icon');
                    if (newValue === 1) {
                        $this.removeClass('status-hide').addClass('status-show');
                        $icon.removeClass('layui-icon-close-fill').addClass('layui-icon-ok-circle');
                        $icon[0].nextSibling.nodeValue = '是';
                    } else {
                        $this.removeClass('status-show').addClass('status-hide');
                        $icon.removeClass('layui-icon-ok-circle').addClass('layui-icon-close-fill');
                        $icon[0].nextSibling.nodeValue = '否';
                    }
                    layer.msg('更新成功', { icon: 1, time: 1000 });
                });
            });
        })

    </script>
</body>

</html>