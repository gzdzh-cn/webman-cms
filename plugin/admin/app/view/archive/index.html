<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="utf-8">
        <title>浏览页面</title>
        <link rel="stylesheet" href="/app/admin/component/pear/css/pear.css" />
        <link rel="stylesheet" href="/app/admin/admin/css/reset.css" />
        <style>
            body.pear-container {
                margin: 10px;
                height: calc(100vh - 20px);
                overflow: hidden;
            }
            #leftSidebar {
                width: 200px;
                float: left;
                padding-right: 15px;
                height: 100%;
                transition: width 0.3s ease;
            }
            #leftSidebar.hidden {
                width: 0;
                padding-right: 0;
                overflow: hidden;
            }
            #rightContent {
                margin-left: 215px;
                height: 100%;
                transition: margin-left 0.3s ease;
            }
            #rightContent.expanded {
                margin-left: 0;
            }
            #sidebarToggleBtn {
                position: absolute;
                left: 200px;
                top: 50%;
                transform: translateY(-50%);
                width: 20px;
                height: 60px;
                background-color: #f0f0f0;
                border: 1px solid #ddd;
                border-left: none;
                border-radius: 0 4px 4px 0;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                transition: left 0.3s ease;
                box-shadow: 2px 0 4px rgba(0,0,0,0.1);
            }
            #sidebarToggleBtn:hover {
                background-color: #e0e0e0;
            }
            #sidebarToggleBtn.hidden {
                left: 0;
            }
            #sidebarToggleBtn i {
                font-size: 14px;
                color: #666;
            }
        </style>
    </head>
    <body class="pear-container">
    
        <!-- 顶部查询表单 -->
		<div class="layui-card">
			<div class="layui-card-body">
				<form class="layui-form" action="">
					<div class="layui-form-item">
						<div class="layui-form-item layui-inline">
							<label class="layui-form-label">标题</label>
							<div class="layui-input-inline">
								<input type="text" name="title" placeholder="请输入标题" class="layui-input">
							</div>
						</div>
						<div class="layui-form-item layui-inline">
							<label class="layui-form-label">审核状态</label>
							<div class="layui-input-inline">
								<select name="arcrank">
									<option value="">全部</option>
									<option value="0">已审核</option>
									<option value="-1">待审核</option>
								</select>
							</div>
						</div>
						<div class="layui-form-item layui-inline">
							<button class="pear-btn pear-btn-md pear-btn-primary" lay-submit lay-filter="archive-query">
								<i class="layui-icon layui-icon-search"></i>
								查询
							</button>
							<button type="reset" class="pear-btn pear-btn-md">
								<i class="layui-icon layui-icon-refresh"></i>
								重置
							</button>
						</div>
					</div>
				</form>
			</div>
		</div>
        
        <!-- 左右分栏布局 -->
        <div class="layui-row" style="margin: 15px 0 0 0; height: calc(100vh - 150px); overflow: hidden; position: relative;">
            <!-- 左侧栏目树 -->
            <div id="leftSidebar">
                <div class="layui-card" style="height: 100%; margin: 0;">
                    <div class="layui-card-body" style="padding: 15px; height: 100%; overflow: hidden; display: flex; flex-direction: column;">
                        <div style="margin-bottom: 10px;">
                            <button id="treeExpandBtn" class="pear-btn pear-btn-sm" style="width: 100%;">
                                <i class="layui-icon layui-icon-spread-left"></i> 展开全部
                            </button>
                        </div>
                        <div id="arctypeTreeContent" style="overflow: auto; flex: 1;">
                            <ul id="arctypeTree" class="dtree arctypeTree" data-id="0"></ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 吸附按钮 -->
            <div id="sidebarToggleBtn" title="隐藏/显示左侧栏目">
                <i class="layui-icon layui-icon-left"></i>
            </div>
            <!-- 右侧内容列表 -->
            <div id="rightContent">
                <div class="layui-card" style="height: 100%; margin: 0;">
                    <div class="layui-card-body" style="padding: 15px; height: 100%; overflow: hidden;">
                <table id="data-table" lay-filter="data-table"></table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 表格顶部工具栏 -->
        <script type="text/html" id="table-toolbar">
            <button class="pear-btn pear-btn-primary pear-btn-xs" lay-event="add" permission="app.admin.archive.insert">
                <i class="layui-icon layui-icon-add-1"></i>新增
            </button>
            <button class="pear-btn pear-btn-danger pear-btn-xs" lay-event="batchRemove" permission="app.admin.archive.delete">
                <i class="layui-icon layui-icon-delete"></i>删除
            </button>
        </script>

        <!-- 表格行工具栏 -->
        <script type="text/html" id="table-bar">
            <span class="pear-text pear-text-primary" lay-event="edit" permission="app.admin.archive.update">编辑 |</span>
            <span class="pear-text pear-text-primary" lay-event="remove" permission="app.admin.archive.delete">删除 |</span>
            <span class="pear-text pear-text-primary" lay-event="view" permission="app.admin.archive.view">浏览</span>
        </script>

        <script src="/app/admin/component/layui/layui.js?v=2.13.12"></script>
        <script src="/app/admin/component/pear/pear.js"></script>
        <script src="/app/admin/admin/js/permission.js"></script>
        <script src="/app/admin/admin/js/common.js"></script>
        
        <script>

            // 相关常量
            const PRIMARY_KEY = "aid";
            const SELECT_API = "/app/admin/archive/select";
            const UPDATE_API = "/app/admin/archive/update";
            const DELETE_API = "/app/admin/archive/delete";
            const INSERT_URL = "/app/admin/archive/insert";
            const UPDATE_URL = "/app/admin/archive/update";
            const ARCTYPE_SELECT_API = "/app/admin/arctype/select";
            
            // 当前选中的栏目ID
            let currentTypeId = 0;
            // 保存完整的树数据
            let treeData = [];
            
            // 表格渲染
            layui.use(["table", "form", "pearCommon", "pearPopup", "util", "pearDtree"], function() {
                let table = layui.table;
                let form = layui.form;
                let $ = layui.$;
                let common = layui.pearCommon;
                let util = layui.util;
                let dtree = layui.pearDtree;
                
				// 表头参数
				let cols = [
					{
						type: "checkbox",
						align: "center",
						width: 50
					},{
						title: "ID",
						align: "center",
						field: "aid",
						width: 80
					},{
						title: "标题",
						align: "left",
						field: "title",
						minWidth: 200
					},{
						title: "栏目",
						align: "center",
						field: "typename",
						width: 150
					},{
						title: "审核",
						align: "center",
						field: "arcrank",
						templet: function (d) {
							const isAudited = d.arcrank == 0;
							const cls = isAudited ? "status-show" : "status-hide";
							const icon = isAudited ? "layui-icon-ok-circle" : "layui-icon-close-fill";
							const text = isAudited ? "是" : "否";
							const val = d.arcrank || -1;
							return '<span class="status-badge ' + cls + '" data-id="' + util.escape(d.aid) + '" data-field="arcrank" data-value="' + val + '"><i class="layui-icon ' + icon + '"></i>' + text + '</span>';
						},
						width: 80
					},{
						title: "点击",
						align: "center",
						field: "click",
						width: 80
					},{
						title: "发布时间",
						align: "center",
						field: "add_time",
						templet: function (d) {
							if (!d.add_time) return '';
							const date = new Date(d.add_time * 1000);
							return date.getFullYear() + '-' + 
								String(date.getMonth() + 1).padStart(2, '0') + '-' + 
								String(date.getDate()).padStart(2, '0') + ' ' +
								String(date.getHours()).padStart(2, '0') + ':' + 
								String(date.getMinutes()).padStart(2, '0');
						},
						width: 160
					},{
						title: "操作",
						toolbar: "#table-bar",
						align: "center",
						fixed: "right",
						width: 150
					},{
						title: "排序",
						align: "center",
						field: "sort_order",
						templet: function (d) {
							return '<span class="sort-order-cell" data-id="' + d.aid + '" data-value="' + (d.sort_order || 0) + '" style="cursor:pointer;padding:5px;display:inline-block;min-width:40px;">' + (d.sort_order || 0) + '</span>';
						},
						width: 80
					}
				];
				
				// 渲染表格
				table.render({
				    elem: "#data-table",
				    url: SELECT_API,
				    page: true,
				    cols: [cols],
				    skin: "line",
				    size: "lg",
				    height: 'full',  // 表格高度占满容器
				    toolbar: "#table-toolbar",
				    autoSort: false,
				    defaultToolbar: [{
				        title: "刷新",
				        layEvent: "refresh",
				        icon: "layui-icon-refresh",
				    }, "filter", "print", "exports"],
				    done: function () {
				        layer.photos({photos: 'div[lay-id="data-table"]', anim: 5});
				    }
				});
				
				// 树展开/缩进状态
				let isTreeExpanded = false;
				
				// 初始化栏目树
				var DTree = dtree.render({
					elem: "#arctypeTree",
					initLevel: "1",  // 设置为 1，默认不展开，只显示根节点
					line: true,
					ficon: ["1", "-1"],
					icon: ["0", "2"],
					method: 'get',
					url: ARCTYPE_SELECT_API + "?format=tree&limit=1000",
					dataStyle: "layuiStyle",  // 使用 layui 风格，直接从 result.code 读取，而不是 result.status.code
					response: {
						statusName: "code",
						statusCode: 0,  // 我们的 API 返回 code: 0 表示成功
						message: "msg",
						rootName: "data",
						treeId: "id",
						parentId: "parentId",
						title: "title",
						childName: "children"
					},
					done: function() {
						// 树加载完成后，获取完整树数据并保存
						$.ajax({
							url: ARCTYPE_SELECT_API + "?format=tree&limit=1000",
							type: 'get',
							dataType: 'json',
							success: function(result) {
								if (result.code === 0 && result.data) {
									treeData = result.data;
								}
							}
						});
					}
				});
				
				// 绑定展开/缩进按钮点击事件
				$("#treeExpandBtn").on("click", function() {
					if (isTreeExpanded) {
						// 当前是展开状态，执行缩进
						DTree.menubarMethod().closeAllNode();
						$(this).html('<i class="layui-icon layui-icon-spread-left"></i> 展开全部');
						isTreeExpanded = false;
					} else {
						// 当前是缩进状态，执行展开
						DTree.menubarMethod().openAllNode();
						$(this).html('<i class="layui-icon layui-icon-shrink-right"></i> 缩进全部');
						isTreeExpanded = true;
					}
				});
				
				// 左侧栏目显示/隐藏状态
				let isSidebarVisible = true;
				
				// 绑定吸附按钮点击事件
				$("#sidebarToggleBtn").on("click", function() {
					if (isSidebarVisible) {
						// 隐藏左侧栏目
						$("#leftSidebar").addClass("hidden");
						$("#rightContent").addClass("expanded");
						$("#sidebarToggleBtn").addClass("hidden");
						$("#sidebarToggleBtn i").removeClass("layui-icon-left").addClass("layui-icon-right");
						isSidebarVisible = false;
					} else {
						// 显示左侧栏目
						$("#leftSidebar").removeClass("hidden");
						$("#rightContent").removeClass("expanded");
						$("#sidebarToggleBtn").removeClass("hidden");
						$("#sidebarToggleBtn i").removeClass("layui-icon-right").addClass("layui-icon-left");
						isSidebarVisible = true;
					}
				});
 
				
				/**
				 * 递归获取指定节点及其所有子节点的ID
				 * @param {Array} nodes 树节点数组
				 * @param {string|number} nodeId 目标节点ID
				 * @return {Array} 包含当前节点及其所有子节点ID的数组
				 */
				function getAllChildrenIds(nodes, nodeId) {
					var result = [];
					
					// 递归函数，查找指定节点并收集其所有子节点ID
					function findNodeAndCollectChildren(nodes, targetId) {
						for (var i = 0; i < nodes.length; i++) {
							var node = nodes[i];
							if (String(node.id) === String(targetId)) {
								// 找到目标节点，添加当前节点ID
								result.push(parseInt(node.id));
								// 递归收集所有子节点ID
								if (node.children && node.children.length > 0) {
									collectChildrenIds(node.children);
								}
								return true;
							} else if (node.children && node.children.length > 0) {
								// 继续在子节点中查找
								if (findNodeAndCollectChildren(node.children, targetId)) {
									return true;
								}
							}
						}
						return false;
					}
					
					// 递归收集所有子节点ID
					function collectChildrenIds(children) {
						for (var i = 0; i < children.length; i++) {
							var child = children[i];
							result.push(parseInt(child.id));
							if (child.children && child.children.length > 0) {
								collectChildrenIds(child.children);
							}
						}
					}
					
					findNodeAndCollectChildren(nodes, nodeId);
					return result;
				}
				
				// 绑定栏目树节点点击事件
				dtree.on("node(arctypeTree)", function(obj) {
					if (!obj.param.leaf) {
						var $div = obj.dom;
						DTree.clickSpread($div);
					}
					// 更新当前选中的栏目ID
					currentTypeId = obj.param.nodeId;
					var where = {};
					if (currentTypeId > 0) {
						// 如果树数据已加载，获取当前节点及其所有子节点的ID
						if (treeData && treeData.length > 0) {
							var allTypeIds = getAllChildrenIds(treeData, currentTypeId);
							if (allTypeIds.length > 0) {
								// 使用 whereIn 查询，传递数组格式
								where.typeid = ['in', allTypeIds.join(',')];
							}
						} else {
							// 树数据未加载完成，只查询当前节点
							where.typeid = currentTypeId;
						}
					}
					table.reload("data-table", {
						where: where,
						page: {
							curr: 1
						}
					});
				});
				
                // 编辑或删除行事件
                table.on("tool(data-table)", function(obj) {
                    if (obj.event === "remove") {
                        remove(obj);
                    } else if (obj.event === "edit") {
                        edit(obj);
                    } else if (obj.event === "view") {
                        view(obj);
                    }
                });

                // 表格顶部工具栏事件
                table.on("toolbar(data-table)", function(obj) {
                    if (obj.event === "add") {
                        add();
                    } else if (obj.event === "refresh") {
                        refreshTable();
                    } else if (obj.event === "batchRemove") {
                        batchRemove(obj);
                    }
                });

                // 表格顶部搜索事件
                form.on("submit(archive-query)", function(data) {
					var where = {};
					if (data.field.title) {
						where.title = ['like', data.field.title];
					}
					if (data.field.arcrank !== '') {
						where.arcrank = data.field.arcrank;
					}
					if (currentTypeId > 0) {
						where.typeid = currentTypeId;
					}
                    table.reload("data-table", {
                        page: {
                            curr: 1
                        },
                        where: where
                    })
                    return false;
                });
                
                // 字段允许为空
                form.verify({
                    phone: [/(^$)|^1\d{10}$/, "请输入正确的手机号"],
                    email: [/(^$)|^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/, "邮箱格式不正确"],
                    url: [/(^$)|(^#)|(^http(s*):\/\/[^\s]+\.[^\s]+)/, "链接格式不正确"],
                    number: [/(^$)|^\d+$/,'只能填写数字'],
                    date: [/(^$)|^(\d{4})[-\/](\d{1}|0\d{1}|1[0-2])([-\/](\d{1}|0\d{1}|[1-2][0-9]|3[0-1]))*$/, "日期格式不正确"],
                    identity: [/(^$)|(^\d{15}$)|(^\d{17}(x|X|\d)$)/, "请输入正确的身份证号"]
                });

                // 表格排序事件
                table.on("sort(data-table)", function(obj){
                    table.reload("data-table", {
                        initSort: obj,
                        scrollPos: "fixed",
                        where: {
                            field: obj.field,
                            order: obj.type
                        }
                    });
                });

                // 表格新增数据
                let add = function() {
                    layer.open({
                        type: 2,
                        title: "新增",
                        shade: 0.1,
                        maxmin: true,
                        area: [common.isModile()?"100%":"500px", common.isModile()?"100%":"450px"],
                        content: INSERT_URL
                    });
                }

                // 表格编辑数据
                let edit = function(obj) {
                    let value = obj.data[PRIMARY_KEY];
                    layer.open({
                        type: 2,
                        title: "修改",
                        shade: 0.1,
                        maxmin: true,
                        area: [common.isModile()?"100%":"500px", common.isModile()?"100%":"450px"],
                        content: UPDATE_URL + "?" + PRIMARY_KEY + "=" + value
                    });
                }
                
                // 浏览数据
                let view = function(obj) {
                    let value = obj.data[PRIMARY_KEY];
                    // 这里可以根据实际需求实现浏览功能，比如打开新窗口查看详情
                    layer.msg('浏览功能待实现，文档ID：' + value);
                }

                // 删除一行
                let remove = function(obj) {
                    return doRemove(obj.data[PRIMARY_KEY]);
                }

                // 删除多行
                let batchRemove = function(obj) {
                    let checkIds = common.checkField(obj, PRIMARY_KEY);
                    if (checkIds === "") {
                        layui.pearPopup.warning("未选中数据");
                        return false;
                    }
                    doRemove(checkIds.split(","));
                }

                // 执行删除
                let doRemove = function (ids) {
                    let data = {};
                    data[PRIMARY_KEY] = ids;
                    layer.confirm("确定删除?", {
                        icon: 3,
                        title: "提示"
                    }, function(index) {
                        layer.close(index);
                        let loading = layer.load();
                        $.ajax({
                            url: DELETE_API,
                            data: data,
                            dataType: "json",
                            type: "post",
                            success: function(res) {
                                layer.close(loading);
                                if (res.code) {
                                    return layui.pearPopup.failure(res.msg);
                                }
                                return layui.pearPopup.success("操作成功", refreshTable);
                            }
                        })
                    });
                }

                // 刷新表格数据
                window.refreshTable = function() {
                    var where = {};
					if (currentTypeId > 0) {
						where.typeid = currentTypeId;
					}
                    table.reload("data-table", {
                        where: where,
                        scrollPos: "fixed",
                        done: function (res, curr) {
                            if (curr > 1 && res.data && !res.data.length) {
                                curr = curr - 1;
                                table.reload("data-table", {
                                    page: {
                                        curr: curr
                                    },
                                })
                            }
                        }
                    });
                }
                
                // 更新字段到数据库
                function updateField(id, field, value, callback) {
                    let data = {};
                    data[PRIMARY_KEY] = id;
                    data[field] = value;
                    $.ajax({
                        url: UPDATE_API,
                        type: "POST",
                        dataType: "json",
                        data: data,
                        success: function (res) {
                            if (res.code) {
                                layui.pearPopup.failure(res.msg);
                                return;
                            }
                            if (callback) callback();
                        },
                        error: function () {
                            layui.pearPopup.failure("请求失败");
                        }
                    });
                }
                
                // 更新排序
                function updateSortOrder(id, sortOrder, successCallback, errorCallback) {
                    updateField(id, 'sort_order', sortOrder, function() {
                        if (successCallback) successCallback();
                    });
                }
                
                // 双击编辑排序
                $(document).on('dblclick', '.sort-order-cell', function(e) {
                    e.stopPropagation();
                    var $this = $(this);
                    var id = $this.data('id');
                    var oldValue = $this.data('value') || 0;
                    var originalStyle = $this.attr('style') || '';
                    var $input = $('<input type="number" class="layui-input" value="' + oldValue + '" style="width:80px;text-align:center;margin:0;border:1px solid #e6e6e6;height:28px;line-height:28px;padding:0 5px;">');
                    $this.html($input);
                    $input.focus().select();
                    
                    $input.on('blur', function() {
                        var newValue = parseInt($(this).val()) || 0;
                        updateSortOrder(id, newValue, function() {
                            $this.data('value', newValue);
                            $this.attr('style', originalStyle);
                            $this.text(newValue);
                            layer.msg('更新成功', { icon: 1, time: 1000 });
                        }, function() {
                            $this.attr('style', originalStyle);
                            $this.text(oldValue);
                        });
                    });
                    
                    $input.on('keydown', function(e) {
                        e.stopPropagation();
                        if (e.keyCode === 13) {
                            $(this).blur();
                        } else if (e.keyCode === 27) {
                            $this.attr('style', originalStyle);
                            $this.text(oldValue);
                            $input.remove();
                        }
                    });
                });
                
                // 点击切换审核状态
                $(document).on('click', '.status-badge', function () {
                    var $this = $(this);
                    var id = $this.data('id');
                    var field = $this.data('field');
                    var currentValue = parseInt($this.data('value')) || -1;
                    // arcrank: 0=已审核, -1=待审核
                    var newValue = currentValue === 0 ? -1 : 0;
                    
                    updateField(id, field, newValue, function () {
                        $this.data('value', newValue);
                        var $icon = $this.find('.layui-icon');
                        if (newValue === 0) {
                            $this.removeClass('status-hide').addClass('status-show');
                            $icon.removeClass('layui-icon-close-fill').addClass('layui-icon-ok-circle');
                            $icon[0].nextSibling.nodeValue = '是';
                        } else {
                            $this.removeClass('status-show').addClass('status-hide');
                            $icon.removeClass('layui-icon-ok-circle').addClass('layui-icon-close-fill');
                            $icon[0].nextSibling.nodeValue = '否';
                        }
                        layer.msg('更新成功', { icon: 1, time: 1000 });
                    });
                });
            })

        </script>
    </body>
</html>
