<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8">
    <title>浏览页面</title>
    <link rel="stylesheet" href="/app/admin/component/pear/css/pear.css" />
    <link rel="stylesheet" href="/app/admin/admin/css/reset.css" />
    <style>
        body.pear-container {
            margin: 10px;
            height: calc(100vh - 20px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .query-form-container {
            flex-shrink: 0;
        }

        #leftSidebar {
            width: 200px;
            float: left;
            padding-right: 15px;
            height: 100%;
            transition: width 0.3s ease;
        }

        #leftSidebar.hidden {
            width: 0;
            padding-right: 0;
            overflow: hidden;
        }

        #rightContent {
            margin-left: 215px;
            height: 100%;
            transition: margin-left 0.3s ease;
        }

        #rightContent.expanded {
            margin-left: 0;
        }

        #sidebarToggleBtn {
            position: absolute;
            left: 200px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 60px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-left: none;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: left 0.3s ease;
            box-shadow: 2px 0 4px rgba(0, 0, 0, 0.1);
        }

        #sidebarToggleBtn:hover {
            background-color: #e0e0e0;
        }

        #sidebarToggleBtn.hidden {
            left: 0;
        }

        #sidebarToggleBtn i {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>

<body class="pear-container">

    <!-- 顶部查询表单 -->
    <div class="query-form-container">
        <div class="layui-card">
            <div class="layui-card-body">
                <form class="layui-form" action="">
                    <div class="layui-form-item">
                        <div class="layui-form-item layui-inline">
                            <label class="layui-form-label">标题</label>
                            <div class="layui-input-inline">
                                <input type="text" name="title" placeholder="请输入标题" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item layui-inline">
                            <label class="layui-form-label">审核状态</label>
                            <div class="layui-input-inline">
                                <select name="arcrank">
                                    <option value="">全部</option>
                                    <option value="0">已审核</option>
                                    <option value="-1">待审核</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-form-item layui-inline">
                            <button class="pear-btn pear-btn-md pear-btn-primary" lay-submit lay-filter="archive-query">
                                <i class="layui-icon layui-icon-search"></i>
                                查询
                            </button>
                            <button type="reset" class="pear-btn pear-btn-md" lay-submit lay-filter="archive-reset">
                                <i class="layui-icon layui-icon-refresh"></i>
                                重置
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 左右分栏布局 -->
    <div class="layui-row"
        style="margin: 10px 0 0 0; flex: 1; min-height: 0; overflow: hidden; position: relative;">
        <!-- 左侧栏目树 -->
        <div id="leftSidebar">
            <div class="layui-card" style="height: 100%; margin: 0;">
                <div class="layui-card-body"
                    style="padding: 15px; height: 100%; overflow: hidden; display: flex; flex-direction: column;">
                    <div style="margin-bottom: 10px;">
                        <button id="treeExpandBtn" class="pear-btn pear-btn-sm" style="width: 100%;">
                            <i class="layui-icon layui-icon-spread-left"></i> 展开全部
                        </button>
                    </div>
                    <div id="arctypeTreeContent" style="overflow: auto; flex: 1;">
                        <ul id="arctypeTree" class="dtree arctypeTree" data-id="0"></ul>
                    </div>
                </div>
            </div>
        </div>
        <!-- 吸附按钮 -->
        <div id="sidebarToggleBtn" title="隐藏/显示左侧栏目">
            <i class="layui-icon layui-icon-left"></i>
        </div>
        <!-- 右侧内容列表 -->
        <div id="rightContent">
            <div class="layui-card" style="height: 100%; margin: 0;">

                <!-- 列表模型显示 -->
                <div id="listModelContainer" class="layui-card-body" style="padding: 15px; height: 100%; overflow: hidden;">
                    <table id="data-table" lay-filter="data-table"></table>
                </div>

                <!-- 单页模型表单编辑 -->
                <div id="singlePageContainer" class="layui-card-body" style="padding: 15px; height: 100%; overflow: hidden; display: none;">
                    <iframe id="singlePageIframe" src="" style="width: 100%; height: 100%; border: none;"></iframe>
                </div>

                <!-- 新增/编辑页面容器 -->
                <div id="formContainer" class="layui-card-body" style="padding: 15px; height: 100%; overflow: hidden; display: none;">
                    <iframe id="formIframe" src="" style="width: 100%; height: 100%; border: none;"></iframe>
                </div>

            </div>
        </div>
    </div>

    <!-- 表格顶部工具栏 -->
    <script type="text/html" id="table-toolbar">
            <button class="pear-btn pear-btn-primary pear-btn-xs" lay-event="add" permission="app.admin.archive.insert">
                <i class="layui-icon layui-icon-add-1"></i>新增
            </button>
            <button class="pear-btn pear-btn-danger pear-btn-xs" lay-event="batchRemove" permission="app.admin.archive.delete">
                <i class="layui-icon layui-icon-delete"></i>删除
            </button>
        </script>

    <!-- 表格行工具栏 -->
    <script type="text/html" id="table-bar">
            <span class="pear-text pear-text-primary" lay-event="edit" permission="app.admin.archive.update">编辑 |</span>
            <span class="pear-text pear-text-primary" lay-event="remove" permission="app.admin.archive.delete">删除 |</span>
            <span class="pear-text pear-text-primary" lay-event="view" permission="app.admin.archive.view">浏览</span>
    </script>

    <script src="/app/admin/component/layui/layui.js?v=2.13.12"></script>
    <script src="/app/admin/component/pear/pear.js"></script>
    <script src="/app/admin/admin/js/permission.js"></script>
    <script src="/app/admin/admin/js/common.js"></script>

    <script>

        // 相关常量
        const PRIMARY_KEY = "aid";
        const SELECT_API = "/app/admin/archive/select";
        const UPDATE_API = "/app/admin/archive/update";
        const DELETE_API = "/app/admin/archive/delete";
        const INSERT_URL = "/app/admin/archive/insert";
        const UPDATE_URL = "/app/admin/archive/update";
        const ARCTYPE_SELECT_API = "/app/admin/arctype/select";

         // 当前选中的栏目ID
         let currentTypeId = 0;
         // 当前选中栏目的模型ID
         let currentChannelId = 0;
         // 保存完整的树数据（包含模型信息）
         let treeData = [];
         // 栏目信息映射表（id -> {current_channel, ...}）
         let arctypeInfoMap = {};

        // 表格渲染
        layui.use(["table", "form", "pearCommon", "pearPopup", "util", "pearDtree"], function () {
            let table = layui.table;
            let form = layui.form;
            let $ = layui.$;
            let common = layui.pearCommon;
            let util = layui.util;
            let dtree = layui.pearDtree;

            // 表头参数
            let cols = [
                {
                    type: "checkbox",
                    align: "center",
                    width: 50
                }, {
                    title: "ID",
                    align: "center",
                    field: "aid",
                    width: 80
                }, {
                    title: "标题",
                    align: "left",
                    field: "title",
                    minWidth: 200
                }, {
                    title: "栏目",
                    align: "center",
                    field: "typename",
                    width: 150
                }, {
                    title: "审核",
                    align: "center",
                    field: "arcrank",
                    templet: function (d) {
                        const isAudited = d.arcrank == 0;
                        const cls = isAudited ? "status-show" : "status-hide";
                        const icon = isAudited ? "layui-icon-ok-circle" : "layui-icon-close-fill";
                        const text = isAudited ? "是" : "否";
                        const val = d.arcrank || -1;
                        return '<span class="status-badge ' + cls + '" data-id="' + util.escape(d.aid) + '" data-field="arcrank" data-value="' + val + '"><i class="layui-icon ' + icon + '"></i>' + text + '</span>';
                    },
                    width: 80
                }, {
                    title: "点击",
                    align: "center",
                    field: "click",
                    width: 80
                }, {
                    title: "发布时间",
                    align: "center",
                    field: "add_time",
                    templet: function (d) {
                        if (!d.add_time) return '';
                        const date = new Date(d.add_time * 1000);
                        return date.getFullYear() + '-' +
                            String(date.getMonth() + 1).padStart(2, '0') + '-' +
                            String(date.getDate()).padStart(2, '0') + ' ' +
                            String(date.getHours()).padStart(2, '0') + ':' +
                            String(date.getMinutes()).padStart(2, '0');
                    },
                    width: 160
                }, {
                    title: "操作",
                    toolbar: "#table-bar",
                    align: "center",
                    fixed: "right",
                    width: 150
                }, {
                    title: "排序",
                    align: "center",
                    field: "sort_order",
                    templet: function (d) {
                        return '<span class="sort-order-cell" data-id="' + d.aid + '" data-value="' + (d.sort_order || 0) + '" style="cursor:pointer;padding:5px;display:inline-block;min-width:40px;">' + (d.sort_order || 0) + '</span>';
                    },
                    width: 80
                }
            ];

            // 渲染表格
            table.render({
                elem: "#data-table",
                url: SELECT_API,
                page: true,
                cols: [cols],
                skin: "line",
                size: "lg",
                height: 'full',  // 表格高度占满容器
                toolbar: "#table-toolbar",
                autoSort: false,
                defaultToolbar: [{
                    title: "刷新",
                    layEvent: "refresh",
                    icon: "layui-icon-refresh",
                }, "filter", "print", "exports"],
                where: {
                    exclude_channel: '6,8'  // 排除单页模型(6)和留言模型(8)
                },
                done: function () {
                    layer.photos({ photos: 'div[lay-id="data-table"]', anim: 5 });
                }
            });

            // 树展开/缩进状态
            let isTreeExpanded = false;

            // 初始化栏目树
            var DTree; // 声明在外部作用域，以便后续使用
            
            // 先获取树数据，避免重复请求
            $.ajax({
                url: ARCTYPE_SELECT_API + "?format=tree&limit=1000",
                type: 'get',
                dataType: 'json',
                success: function (result) {
                    if (result.code === 0 && result.data) {
                        treeData = result.data;
                        // 构建栏目信息映射表
                        function buildArctypeMap(nodes) {
                            if (!Array.isArray(nodes)) return;
                            nodes.forEach(function (node) {
                                if (node.id) {
                                    var id = String(node.id); // 统一使用字符串作为key
                                    arctypeInfoMap[id] = {
                                        current_channel: parseInt(node.current_channel) || 0,
                                        typename: node.typename || node.title || ''
                                    };
                                }
                                if (node.children && Array.isArray(node.children)) {
                                    buildArctypeMap(node.children);
                                }
                            });
                        }
                        buildArctypeMap(result.data);

                        // 使用已获取的数据初始化树组件
                        DTree = dtree.render({
                            elem: "#arctypeTree",
                            initLevel: "1",  // 设置为 1，默认不展开，只显示根节点
                            line: true,
                            ficon: ["1", "-1"],
                            icon: ["0", "2"],
                            data: result.data,  // 直接使用已获取的数据
                            dataStyle: "layuiStyle",
                            response: {
                                statusName: "code",
                                statusCode: 0,
                                message: "msg",
                                rootName: "data",
                                treeId: "id",
                                parentId: "parentId",
                                title: "title",
                                childName: "children"
                            }
                        });
                    }
                },
                error: function (xhr, status, error) {
                    console.error('加载栏目树数据失败:', error);
                    // 如果请求失败，仍然尝试使用 url 方式初始化树组件
                    DTree = dtree.render({
                        elem: "#arctypeTree",
                        initLevel: "1",
                        line: true,
                        ficon: ["1", "-1"],
                        icon: ["0", "2"],
                        method: 'get',
                        url: ARCTYPE_SELECT_API + "?format=tree&limit=1000",
                        dataStyle: "layuiStyle",
                        response: {
                            statusName: "code",
                            statusCode: 0,
                            message: "msg",
                            rootName: "data",
                            treeId: "id",
                            parentId: "parentId",
                            title: "title",
                            childName: "children"
                        }
                    });
                }
            });

            // 绑定展开/缩进按钮点击事件
            $("#treeExpandBtn").on("click", function () {
                if (isTreeExpanded) {
                    // 当前是展开状态，执行缩进
                    DTree.menubarMethod().closeAllNode();
                    $(this).html('<i class="layui-icon layui-icon-spread-left"></i> 展开全部');
                    isTreeExpanded = false;
                } else {
                    // 当前是缩进状态，执行展开
                    DTree.menubarMethod().openAllNode();
                    $(this).html('<i class="layui-icon layui-icon-shrink-right"></i> 缩进全部');
                    isTreeExpanded = true;
                }
            });

            // 左侧栏目显示/隐藏状态
            let isSidebarVisible = true;

            // 绑定吸附按钮点击事件
            $("#sidebarToggleBtn").on("click", function () {
                if (isSidebarVisible) {
                    // 隐藏左侧栏目
                    $("#leftSidebar").addClass("hidden");
                    $("#rightContent").addClass("expanded");
                    $("#sidebarToggleBtn").addClass("hidden");
                    $("#sidebarToggleBtn i").removeClass("layui-icon-left").addClass("layui-icon-right");
                    isSidebarVisible = false;
                } else {
                    // 显示左侧栏目
                    $("#leftSidebar").removeClass("hidden");
                    $("#rightContent").removeClass("expanded");
                    $("#sidebarToggleBtn").removeClass("hidden");
                    $("#sidebarToggleBtn i").removeClass("layui-icon-right").addClass("layui-icon-left");
                    isSidebarVisible = true;
                }
            });


            /**
             * 递归获取指定节点及其所有子节点的ID
             * @param {Array} nodes 树节点数组
             * @param {string|number} nodeId 目标节点ID
             * @return {Array} 包含当前节点及其所有子节点ID的数组
             */
            function getAllChildrenIds(nodes, nodeId) {
                var result = [];

                // 递归函数，查找指定节点并收集其所有子节点ID
                function findNodeAndCollectChildren(nodes, targetId) {
                    for (var i = 0; i < nodes.length; i++) {
                        var node = nodes[i];
                        if (String(node.id) === String(targetId)) {
                            // 找到目标节点，添加当前节点ID
                            result.push(parseInt(node.id));
                            // 递归收集所有子节点ID
                            if (node.children && node.children.length > 0) {
                                collectChildrenIds(node.children);
                            }
                            return true;
                        } else if (node.children && node.children.length > 0) {
                            // 继续在子节点中查找
                            if (findNodeAndCollectChildren(node.children, targetId)) {
                                return true;
                            }
                        }
                    }
                    return false;
                }

                // 递归收集所有子节点ID
                function collectChildrenIds(children) {
                    for (var i = 0; i < children.length; i++) {
                        var child = children[i];
                        result.push(parseInt(child.id));
                        if (child.children && child.children.length > 0) {
                            collectChildrenIds(child.children);
                        }
                    }
                }

                findNodeAndCollectChildren(nodes, nodeId);
                return result;
            }

            // 从树数据中查找节点信息
            function findNodeInTree(nodes, nodeId) {
                if (!Array.isArray(nodes)) return null;
                for (var i = 0; i < nodes.length; i++) {
                    var node = nodes[i];
                    if (parseInt(node.id) === parseInt(nodeId)) {
                        return node;
                    }
                    if (node.children && Array.isArray(node.children)) {
                        var found = findNodeInTree(node.children, nodeId);
                        if (found) return found;
                    }
                }
                return null;
            }

            // 绑定栏目树节点点击事件
            dtree.on("node(arctypeTree)", function (obj) {
                // 获取点击事件对象
                var event = obj.event || window.event;
                if (!event) {
                    // 如果没有事件对象，默认执行完整逻辑
                    handleNodeClick(obj);
                    return;
                }
                
                var target = event.target || event.srcElement;
                var $target = $(target);
                var $node = $(obj.dom);
                
                // 检查点击的是否是图标区域
                // pearDtree 的图标通常在 .dtree-icon 或包含 i 标签的元素中
                var isIconClick = false;
                
                // 检查点击目标及其父元素是否是图标相关元素
                if ($target.is('i') || 
                    $target.hasClass('dtree-icon') || 
                    $target.hasClass('dtree-iconfont') ||
                    $target.closest('.dtree-icon, .dtree-iconfont, i').length > 0) {
                    isIconClick = true;
                }
                
                // 检查点击的是否是展开/折叠按钮区域（通常在节点左侧）
                var nodeOffset = $node.offset();
                var nodeWidth = $node.width();
                var clickX = event.pageX || event.clientX;
                
                // 如果点击位置在节点左侧30px内，认为是点击图标区域
                if (clickX && nodeOffset && (clickX - nodeOffset.left) < 30) {
                    isIconClick = true;
                }
                
                // 如果是非叶子节点且点击的是图标区域，只展开/折叠
                if (!obj.param.leaf && isIconClick) {
                    var $div = obj.dom;
                    DTree.clickSpread($div);
                    return; // 只展开/折叠，不执行后续逻辑
                }
                
                // 如果点击的是名称区域，只更新右侧内容，不展开/折叠
                handleNodeClick(obj);
            });
            
            // 处理节点点击（更新右侧内容）
            function handleNodeClick(obj) {
                // 更新当前选中的栏目ID和模型ID
                currentTypeId = parseInt(obj.param.nodeId) || 0;
                currentChannelId = 0;

                // 优先从树数据中查找节点信息
                if (currentTypeId > 0 && treeData && treeData.length > 0) {
                    var nodeInfo = findNodeInTree(treeData, currentTypeId);
                    if (nodeInfo && nodeInfo.current_channel) {
                        currentChannelId = parseInt(nodeInfo.current_channel) || 0;
                    }
                }

                // 如果树数据中没有，从映射表中获取
                if (currentChannelId === 0) {
                    var nodeIdStr = String(currentTypeId);
                    if (arctypeInfoMap[nodeIdStr]) {
                        currentChannelId = parseInt(arctypeInfoMap[nodeIdStr].current_channel) || 0;
                    }
                }

                // 如果还是没有，从后端获取栏目详情
                if (currentTypeId > 0 && currentChannelId === 0) {
                    $.ajax({
                        url: ARCTYPE_SELECT_API,
                        type: 'get',
                        dataType: 'json',
                        data: { id: currentTypeId },
                        async: false, // 同步请求，确保获取到模型ID后再判断
                        success: function (result) {
                            if (result.code === 0 && result.data && result.data.length > 0) {
                                var arctypeInfo = result.data[0];
                                currentChannelId = parseInt(arctypeInfo.current_channel) || 0;
                                // 更新映射表
                                var nodeIdStr = String(currentTypeId);
                                arctypeInfoMap[nodeIdStr] = {
                                    current_channel: currentChannelId,
                                    typename: arctypeInfo.typename || ''
                                };
                            }
                        }
                    });
                }

                // 如果是单页模型（channel_id=6）或留言模型（channel_id=8），显示表单编辑
                if (currentTypeId > 0 && (currentChannelId == 6 || currentChannelId == 8)) {
                    // 隐藏列表容器和表单容器，显示单页表单容器
                    $("#listModelContainer").hide();
                    $("#formContainer").hide();
                    $("#singlePageContainer").show();
                    // 加载单页模型编辑页面到iframe
                    $("#singlePageIframe").attr("src", "/app/admin/archive/singlePage?id=" + currentTypeId);
                } else {
                    // 其他模型，显示内容列表
                    // 隐藏单页表单容器和表单容器，显示列表容器
                    $("#singlePageContainer").hide();
                    $("#formContainer").hide();
                    $("#listModelContainer").show();
                    
                    var where = {
                        exclude_channel: '6,8'  // 排除单页模型(6)和留言模型(8)
                    };
                    if (currentTypeId > 0) {
                        // 如果树数据已加载，获取当前节点及其所有子节点的ID
                        if (treeData && treeData.length > 0) {
                            var allTypeIds = getAllChildrenIds(treeData, currentTypeId);
                            if (allTypeIds.length > 0) {
                                // 使用 whereIn 查询，传递数组格式
                                where.typeid = ['in', allTypeIds.join(',')];
                            }
                        } else {
                            // 树数据未加载完成，只查询当前节点
                            where.typeid = currentTypeId;
                        }
                    }
                    table.reload("data-table", {
                        where: where,
                        page: {
                            curr: 1
                        }
                    });
                }
            }

            // 编辑或删除行事件
            table.on("tool(data-table)", function (obj) {
                if (obj.event === "remove") {
                    remove(obj);
                } else if (obj.event === "edit") {
                    edit(obj);
                } else if (obj.event === "view") {
                    view(obj);
                }
            });

            // 表格顶部工具栏事件
            table.on("toolbar(data-table)", function (obj) {
                if (obj.event === "add") {
                    add();
                } else if (obj.event === "refresh") {
                    refreshTable();
                } else if (obj.event === "batchRemove") {
                    batchRemove(obj);
                }
            });

            // 表格顶部搜索事件
            form.on("submit(archive-query)", function (data) {
                var where = {
                    exclude_channel: '6,8'  // 排除单页模型(6)和留言模型(8)
                };
                if (data.field.title) {
                    where.title = ['like', data.field.title];
                }
                if (data.field.arcrank !== '') {
                    where.arcrank = data.field.arcrank;
                }
                if (currentTypeId > 0) {
                    // 如果树数据已加载，获取当前节点及其所有子节点的ID
                    if (treeData && treeData.length > 0) {
                        var allTypeIds = getAllChildrenIds(treeData, currentTypeId);
                        if (allTypeIds.length > 0) {
                            // 使用 whereIn 查询，传递数组格式
                            where.typeid = ['in', allTypeIds.join(',')];
                        }
                    } else {
                        // 树数据未加载完成，只查询当前节点
                        where.typeid = currentTypeId;
                    }
                }
                table.reload("data-table", {
                    page: {
                        curr: 1
                    },
                    where: where
                })
                return false;
            });

            // 表格顶部搜索重置事件
            form.on("submit(archive-reset)", function (data) {
                // 保留 currentTypeId，不重置栏目筛选
                // 只重置搜索条件（title、arcrank）
                // 重置表单字段（清空搜索条件）
                $("form.layui-form")[0].reset();
                // 重新渲染表单，确保下拉框等组件也重置
                form.render();
                
                // 根据 currentTypeId 重新加载表格
                var where = {
                    exclude_channel: '6,8'  // 排除单页模型(6)和留言模型(8)
                };
                
                if (currentTypeId > 0) {
                    // 如果选中了栏目，显示该栏目及其所有子节点的数据
                    if (treeData && treeData.length > 0) {
                        var allTypeIds = getAllChildrenIds(treeData, currentTypeId);
                        if (allTypeIds.length > 0) {
                            // 使用 whereIn 查询，传递数组格式
                            where.typeid = ['in', allTypeIds.join(',')];
                        }
                    } else {
                        // 树数据未加载完成，只查询当前节点
                        where.typeid = currentTypeId;
                    }
                }
                // 如果 currentTypeId === 0，显示全部数据（排除单页和留言模型）
                
                table.reload("data-table", {
                    where: where,
                    page: {
                        curr: 1
                    }
                });
                return false;
            });

            // 字段允许为空
            form.verify({
                phone: [/(^$)|^1\d{10}$/, "请输入正确的手机号"],
                email: [/(^$)|^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/, "邮箱格式不正确"],
                url: [/(^$)|(^#)|(^http(s*):\/\/[^\s]+\.[^\s]+)/, "链接格式不正确"],
                number: [/(^$)|^\d+$/, '只能填写数字'],
                date: [/(^$)|^(\d{4})[-\/](\d{1}|0\d{1}|1[0-2])([-\/](\d{1}|0\d{1}|[1-2][0-9]|3[0-1]))*$/, "日期格式不正确"],
                identity: [/(^$)|(^\d{15}$)|(^\d{17}(x|X|\d)$)/, "请输入正确的身份证号"]
            });

            // 表格排序事件
            table.on("sort(data-table)", function (obj) {
                table.reload("data-table", {
                    initSort: obj,
                    scrollPos: "fixed",
                    where: {
                        field: obj.field,
                        order: obj.type
                    }
                });
            });

            // 表格新增数据
            let add = function () {
                // 从全局变量获取栏目ID和模型ID
                var typeid = currentTypeId || 0;
                var channelId = currentChannelId || 0;
                
                // 如果全局变量没有数值，显示弹窗要求选择栏目
                if (!typeid || typeid === 0 || !channelId || channelId === 0) {
                    showSelectArctypeDialog();
                } else {
                    // 如果全局变量有值，根据模型类型打开对应页面
                    openPageByChannel(typeid, channelId);
                }
            }

            // 显示选择栏目弹窗
            function showSelectArctypeDialog() {
                // 创建弹窗内容
                var dialogContent = '<div style="padding: 20px;">' +
                    '<form class="layui-form" id="selectArctypeForm">' +
                    '<div class="layui-form-item">' +
                    '<label class="layui-form-label required">选择栏目</label>' +
                    '<div class="layui-input-block">' +
                    '<select name="typeid" id="dialog-typeid-select" lay-verify="required" lay-filter="dialog-typeid">' +
                    '<option value="">请选择栏目</option>' +
                    '</select>' +
                    '</div>' +
                    '</div>' +
                    '</form>' +
                    '</div>';

                // 显示弹窗
                var layerIndex = layer.open({
                    type: 1,
                    title: '选择栏目',
                    content: dialogContent,
                    area: ['60%', '600px'],
                    btn: ['确定', '取消'],
                    yes: function(layero, btnIndex) {
                        // 获取选中的栏目ID
                        var selectedTypeId = $('#dialog-typeid-select').val();
                        if (!selectedTypeId || selectedTypeId === '') {
                            layui.pearPopup.warning('请选择栏目');
                            return false;
                        }

                        // 获取选中栏目的channelId
                        var selectedChannelId = 0;
                        if (treeData && treeData.length > 0) {
                            var nodeInfo = findNodeInTree(treeData, selectedTypeId);
                            if (nodeInfo && nodeInfo.current_channel) {
                                selectedChannelId = parseInt(nodeInfo.current_channel) || 0;
                            }
                        }

                        // 如果树数据中没有，从映射表中获取
                        if (selectedChannelId === 0) {
                            var nodeIdStr = String(selectedTypeId);
                            if (arctypeInfoMap[nodeIdStr]) {
                                selectedChannelId = parseInt(arctypeInfoMap[nodeIdStr].current_channel) || 0;
                            }
                        }

                        // 如果还是没有，从后端获取栏目详情
                        if (selectedTypeId > 0 && selectedChannelId === 0) {
                            $.ajax({
                                url: ARCTYPE_SELECT_API,
                                type: 'get',
                                dataType: 'json',
                                data: { id: selectedTypeId },
                                async: false, // 同步请求
                                success: function (result) {
                                    if (result.code === 0 && result.data && result.data.length > 0) {
                                        var arctypeInfo = result.data[0];
                                        selectedChannelId = parseInt(arctypeInfo.current_channel) || 0;
                                    }
                                }
                            });
                        }

                        if (selectedChannelId === 0) {
                            layui.pearPopup.warning('无法获取栏目模型ID');
                            return false;
                        }

                        // 更新当前选中的栏目ID和模型ID到全局变量
                        currentTypeId = parseInt(selectedTypeId);
                        currentChannelId = selectedChannelId;

                        // 关闭弹窗（使用外部作用域的layerIndex）
                        layer.close(layerIndex);

                        // 根据模型类型打开对应页面
                        openPageByChannel(currentTypeId, currentChannelId);
                    },
                    success: function(layero, btnIndex) {
                        // 加载栏目下拉选项
                        loadDialogArctypeOptions();
                    }
                });
            }

            // 加载弹窗中的栏目下拉选项（使用和insert.html一样的树形数据格式）
            function loadDialogArctypeOptions() {
                $.ajax({
                    url: ARCTYPE_SELECT_API + "?format=tree&limit=2000",
                    type: 'get',
                    dataType: 'json',
                    success: function (result) {
                        if (result.code === 0 && result.data && Array.isArray(result.data)) {
                            var $select = $('#dialog-typeid-select');
                            $select.empty();
                            $select.append('<option value="">请选择栏目</option>');

                            // 扁平化树形数据（和insert.html一样的格式）
                            var options = flattenTree(result.data);

                            options.forEach(function (item) {
                                $select.append('<option value="' + item.id + '">' + item.label + '</option>');
                            });
                            form.render('select');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('加载栏目数据请求失败:', error);
                    }
                });
            }

            // 扁平化树形数据（和insert.html一样的实现）
            function flattenTree(nodes, level) {
                level = level || 0;
                var list = [];
                if (!nodes || !Array.isArray(nodes)) {
                    return list;
                }
                nodes.forEach(function (node) {
                    if (!node) return;
                    var indent = level > 0 ? '├─'.repeat(level) : '';
                    var name = node.title || node.name || node.typename || '未命名';
                    list.push({
                        id: node.id,
                        label: indent + name
                    });
                    if (node.children && Array.isArray(node.children) && node.children.length > 0) {
                        list = list.concat(flattenTree(node.children, level + 1));
                    }
                });
                return list;
            }

            // 根据模型类型打开对应页面
            function openPageByChannel(typeid, channelId) {
                // 如果是单页模型（channel_id=6）或留言模型（channel_id=8），打开单页表单
                if (channelId == 6 || channelId == 8) {
                    // 隐藏列表容器和表单容器，显示单页表单容器
                    $("#listModelContainer").hide();
                    $("#formContainer").hide();
                    $("#singlePageContainer").show();
                    // 加载单页模型编辑页面到iframe
                    $("#singlePageIframe").attr("src", "/app/admin/archive/singlePage?id=" + typeid);
                } else {
                    // 其他模型，打开新增页面
                    openInsertPage(typeid, channelId);
                }
            }

            // 打开新增页面
            function openInsertPage(typeid, channelId) {
                // 隐藏列表容器和单页容器，显示表单容器
                $("#listModelContainer").hide();
                $("#singlePageContainer").hide();
                $("#formContainer").show();
                // 构建URL参数，传递typeid和channel_id
                var url = INSERT_URL;
                if (typeid > 0) {
                    url += "?typeid=" + typeid;
                    if (channelId > 0) {
                        url += "&channel_id=" + channelId;
                    }
                }
                // 加载新增页面到iframe
                $("#formIframe").attr("src", url);
            }

            // 表格编辑数据
            let edit = function (obj) {
          
                let value = obj.data[PRIMARY_KEY];
                // 获取当前行的channel字段（模型ID）
                var channelId = obj.data.channel || 0;
                // 隐藏列表容器和单页容器，显示表单容器
                $("#listModelContainer").hide();
                $("#singlePageContainer").hide();
                $("#formContainer").show();
                // 构建URL参数，传递channel_id
                var url = UPDATE_URL + "?" + PRIMARY_KEY + "=" + value;
                if (channelId > 0) {
                    url += "&channel_id=" + channelId;
                }
                // 加载编辑页面到iframe
                $("#formIframe").attr("src", url);
            }

            // 浏览数据
            let view = function (obj) {
                let value = obj.data[PRIMARY_KEY];
                // 这里可以根据实际需求实现浏览功能，比如打开新窗口查看详情
                layer.msg('浏览功能待实现，文档ID：' + value);
            }

            // 删除一行
            let remove = function (obj) {
                return doRemove(obj.data[PRIMARY_KEY]);
            }

            // 删除多行
            let batchRemove = function (obj) {
                let checkIds = common.checkField(obj, PRIMARY_KEY);
                if (checkIds === "") {
                    layui.pearPopup.warning("未选中数据");
                    return false;
                }
                doRemove(checkIds.split(","));
            }

            // 执行删除
            let doRemove = function (ids) {
                let data = {};
                data[PRIMARY_KEY] = ids;
                layer.confirm("确定删除?", {
                    icon: 3,
                    title: "提示"
                }, function (index) {
                    layer.close(index);
                    let loading = layer.load();
                    $.ajax({
                        url: DELETE_API,
                        data: data,
                        dataType: "json",
                        type: "post",
                        success: function (res) {
                            layer.close(loading);
                            if (res.code) {
                                return layui.pearPopup.failure(res.msg);
                            }
                            return layui.pearPopup.success("操作成功", refreshTable);
                        }
                    })
                });
            }

            // 刷新表格数据
            window.refreshTable = function () {
                // 显示列表容器，隐藏表单容器和单页容器
                $("#listModelContainer").show();
                $("#formContainer").hide();
                $("#singlePageContainer").hide();
                
                var where = {
                    exclude_channel: '6,8'  // 排除单页模型(6)和留言模型(8)
                };
                if (currentTypeId > 0) {
                    // 如果树数据已加载，获取当前节点及其所有子节点的ID
                    if (treeData && treeData.length > 0) {
                        var allTypeIds = getAllChildrenIds(treeData, currentTypeId);
                        if (allTypeIds.length > 0) {
                            // 使用 whereIn 查询，传递数组格式
                            where.typeid = ['in', allTypeIds.join(',')];
                        }
                    } else {
                        // 树数据未加载完成，只查询当前节点
                        where.typeid = currentTypeId;
                    }
                }
                table.reload("data-table", {
                    where: where,
                    scrollPos: "fixed",
                    done: function (res, curr) {
                        if (curr > 1 && res.data && !res.data.length) {
                            curr = curr - 1;
                            table.reload("data-table", {
                                page: {
                                    curr: curr
                                },
                            })
                        }
                    }
                });
            }

            // 更新字段到数据库
            function updateField(id, field, value, callback) {
                let data = {};
                data[PRIMARY_KEY] = id;
                data[field] = value;
                $.ajax({
                    url: UPDATE_API,
                    type: "POST",
                    dataType: "json",
                    data: data,
                    success: function (res) {
                        if (res.code) {
                            layui.pearPopup.failure(res.msg);
                            return;
                        }
                        if (callback) callback();
                    },
                    error: function () {
                        layui.pearPopup.failure("请求失败");
                    }
                });
            }

            // 更新排序
            function updateSortOrder(id, sortOrder, successCallback, errorCallback) {
                updateField(id, 'sort_order', sortOrder, function () {
                    if (successCallback) successCallback();
                });
            }

            // 双击编辑排序
            $(document).on('dblclick', '.sort-order-cell', function (e) {
                e.stopPropagation();
                var $this = $(this);
                var id = $this.data('id');
                var oldValue = $this.data('value') || 0;
                var originalStyle = $this.attr('style') || '';
                var $input = $('<input type="number" class="layui-input" value="' + oldValue + '" style="width:80px;text-align:center;margin:0;border:1px solid #e6e6e6;height:28px;line-height:28px;padding:0 5px;">');
                $this.html($input);
                $input.focus().select();

                $input.on('blur', function () {
                    var newValue = parseInt($(this).val()) || 0;
                    updateSortOrder(id, newValue, function () {
                        $this.data('value', newValue);
                        $this.attr('style', originalStyle);
                        $this.text(newValue);
                        layer.msg('更新成功', { icon: 1, time: 1000 });
                    }, function () {
                        $this.attr('style', originalStyle);
                        $this.text(oldValue);
                    });
                });

                $input.on('keydown', function (e) {
                    e.stopPropagation();
                    if (e.keyCode === 13) {
                        $(this).blur();
                    } else if (e.keyCode === 27) {
                        $this.attr('style', originalStyle);
                        $this.text(oldValue);
                        $input.remove();
                    }
                });
            });

            // 点击切换审核状态
            $(document).on('click', '.status-badge', function () {
                var $this = $(this);
                var id = $this.data('id');
                var field = $this.data('field');
                var currentValue = parseInt($this.data('value')) || -1;
                // arcrank: 0=已审核, -1=待审核
                var newValue = currentValue === 0 ? -1 : 0;

                updateField(id, field, newValue, function () {
                    $this.data('value', newValue);
                    var $icon = $this.find('.layui-icon');
                    if (newValue === 0) {
                        $this.removeClass('status-hide').addClass('status-show');
                        $icon.removeClass('layui-icon-close-fill').addClass('layui-icon-ok-circle');
                        $icon[0].nextSibling.nodeValue = '是';
                    } else {
                        $this.removeClass('status-show').addClass('status-hide');
                        $icon.removeClass('layui-icon-ok-circle').addClass('layui-icon-close-fill');
                        $icon[0].nextSibling.nodeValue = '否';
                    }
                    layer.msg('更新成功', { icon: 1, time: 1000 });
                });
            });
        })

    </script>
</body>

</html>