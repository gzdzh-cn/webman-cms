<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <title>新增页面</title>
    <link rel="stylesheet" href="/app/admin/component/pear/css/pear.css" />
    <link rel="stylesheet" href="/app/admin/component/jsoneditor/css/jsoneditor.css" />
    <link rel="stylesheet" href="/app/admin/admin/css/reset.css" />
    <style>
        .mainBox {
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .main-container {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* 让 tabs 区域固定高度，内容滚动，但标题不滚动，且标题层级最高，避免被内容遮挡 */
        .layui-tabs {
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }

        .layui-tabs .layui-tabs-header {
            flex-shrink: 0;
            position: relative;
            z-index: 10;
            background-color: #fff;
        }

        .layui-tabs .layui-tabs-body {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0;
            padding: 10px 15px 80px;
            box-sizing: border-box;
            position: relative;
            z-index: 1;
        }

        .layui-tabs .layui-tabs-body .mainBox {
            height: auto;
            overflow: visible;
        }

        .layui-tabs .layui-tabs-body .main-container {
            height: auto;
            overflow: visible;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
        }

        .bottom {
            flex-shrink: 0;
            background: #fff;
            padding: 8px 40px 8px 0px;
            border-top: 1px solid #e6e6e6;
            z-index: 100;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            display: flex;
            align-items: center;
        }

        .bottom .layui-input-block {
            display: flex;
            justify-content: flex-start;
            padding-right: 25%;
        }

        /* 内容编辑器样式调整，左侧对齐标签 */
        #content-editor-wrapper {
            margin-top: 20px;
        }

        #content-editor-wrapper .layui-form-item {
            margin-bottom: 15px;
        }

        #content-editor-wrapper .layui-input-block {
            margin-left: 0;
            width: 100%;
        }

        #content-editor-wrapper #content-editor-tabs {
            width: 100%;
            margin-bottom: 20px;
        }

        #content-editor-wrapper .layui-tabs {
            margin: 0;
        }

        #content-editor-wrapper .layui-tabs-body {
            padding: 15px 0;
        }
    </style>
</head>

<body>

    <form class="layui-form" action="">

        <div class="mainBox">
            <div class="main-container">
                <!-- Tabs 静态 HTML 结构 -->
                <div class="layui-tabs layui-tabs-card" lay-filter="archive-tabs" lay-options="{index: 0}">
                    <ul class="layui-tabs-header">
                        <li lay-id="base">基础内容</li>
                        <li lay-id="seo">SEO优化</li>
                        <li lay-id="more">更多设置</li>
                    </ul>
                    <div class="layui-tabs-body">
                        <div class="layui-tabs-item" id="tab-base">
                            <div class="mainBox">
                                <div class="main-container mr-5 pb-6">
                                    <!-- 固定字段：基础内容 -->
                                    <div class="layui-form-item">
                                        <label class="layui-form-label required">文档标题</label>
                                        <div class="layui-input-block"
                                            style="display: flex; align-items: center; gap: 15px;">
                                            <div style="flex: 3;">
                                                <input type="text" name="title" lay-verify="required"
                                                    placeholder="请输入文档标题" class="layui-input" maxlength="200">
                                            </div>
                                            <div style="flex: 2; display: flex; align-items: center;">
                                                <span style="margin-right: 10px; white-space: nowrap;">副标题：</span>
                                                <input type="text" name="subtitle" placeholder="请输入副标题"
                                                    class="layui-input">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label required">栏目分类</label>
                                        <div class="layui-input-block">
                                            <select name="typeid" id="typeid-select" lay-verify="required"
                                                lay-filter="typeid">
                                                <option value="">请选择栏目</option>
                                            </select>
                                            <div class="layui-form-mid layui-word-aux">
                                                谨慎切换，自定义字段的内容会随着栏目切换而清空，在保存之前不受影响！</div>
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">文档属性</label>
                                        <div class="layui-input-block">

                                            <input type="checkbox" name="is_head" value="1" title="头条">
                                            <input type="checkbox" name="is_recom" value="1" title="推荐">
                                            <input type="checkbox" name="is_litpic" value="1" title="有图">
                                            <input type="checkbox" name="is_jump" value="1" title="外链">

                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">封面图片</label>
                                        <div class="layui-input-block">
                                            <div class="layui-upload">
                                                <button type="button" class="layui-btn layui-btn-normal"
                                                    id="upload-litpic">选择图片</button>
                                                <div class="layui-upload-list" style="margin-top: 10px;">
                                                    <img class="layui-upload-img" id="preview-litpic" src=""
                                                        style="max-width: 200px; max-height: 200px; display: none;">
                                                    <input type="hidden" name="litpic" id="input-litpic" value="">
                                                    <p id="text-litpic" style="margin-top: 10px;"></p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="layui-form-item" style="position: relative; z-index: 2;">
                                        <label class="layui-form-label">文档标签</label>
                                        <div class="layui-input-block" style="position: relative;">
                                            <input type="text" name="tags" id="tags" placeholder="多个标签之间以逗号隔开"
                                                class="layui-input" autocomplete="off" 
                                                oninput="get_common_tagindex_input(this);" 
                                                onfocus="$('#often_tags').hide();" 
                                                onkeyup="this.value=this.value.replace(/[\，]/g,',');" 
                                                onpaste="this.value=this.value.replace(/[\，]/g,',')">
                                            &nbsp;
                                            <a href="javascript:void(0);" onclick="get_common_tagindex(this);" style="color: #1E9FFF;">显示常用标签</a>
                                            <span id="tag_loading" style="display: none; margin-left: 5px; color: #1E9FFF;">加载中...</span>
                                            <div class="often_tags" id="often_tags" data-opt="edit" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid #e6e6e6; border-radius: 2px; padding: 10px; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 5px;"></div>
                                            <div class="often_tags" id="often_tags_input" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid #e6e6e6; border-radius: 2px; padding: 10px; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 5px;"></div>
                                            <input type="hidden" id="tags_click_count">
                                        </div>
                                    </div>
                                    <style>
                                        .often_tags a {
                                            display: inline-block;
                                            padding: 5px 10px;
                                            margin: 3px;
                                            background: #f5f5f5;
                                            border: 1px solid #e6e6e6;
                                            border-radius: 2px;
                                            cursor: pointer;
                                            color: #333;
                                            text-decoration: none;
                                        }
                                        .often_tags a:hover {
                                            background: #e6e6e6;
                                        }
                                        .often_tags a.cur {
                                            background: #1E9FFF;
                                            color: #fff;
                                            border-color: #1E9FFF;
                                        }
                                    </style>
                                    <!-- 动态字段将追加到这里 -->
                                    <div id="dynamic-fields-container-1"></div>

                                    <!-- 内容编辑器标签页（如果存在 content 或 content_ey_m 字段） -->
                                    <div id="content-editor-wrapper">
                                        <div class="layui-form-item">
                                            <label class="layui-form-label">内容详情</label>
                                            <div class="layui-input-block">
                                                <div id="content-editor-tabs">
                                                    <div class="layui-tabs layui-tabs-card" lay-filter="content-tabs">
                                                        <ul class="layui-tabs-header">
                                                            <li class="layui-this" lay-id="pc">电脑端</li>
                                                            <li lay-id="mobile">移动端</li>
                                                        </ul>
                                                        <div class="layui-tabs-body">
                                                            <div class="layui-tabs-item layui-show" id="tab-pc">
                                                                <textarea id="editor-content" name="content" cols="30"
                                                                    rows="10"></textarea>
                                                            </div>
                                                            <div class="layui-tabs-item" id="tab-mobile">
                                                                <textarea id="editor-content-ey-m" name="content_ey_m"
                                                                    cols="30" rows="10"></textarea>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="layui-tabs-item" id="tab-seo">
                            <div class="mainBox">
                                <div class="main-container mr-5 pb-6">
                                    <!-- 固定字段：SEO优化 -->
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">SEO标题</label>
                                        <div class="layui-input-block">
                                            <input type="text" name="seo_title" placeholder="建议80个字符以内"
                                                class="layui-input">
                                            <div class="layui-form-mid layui-word-aux">建议80个字符以内，不填写则使用默认标题在前端展示</div>
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">SEO关键词</label>
                                        <div class="layui-input-block">
                                            <textarea name="seo_keywords" placeholder="多个关键词请用英文逗号（,）隔开"
                                                class="layui-textarea" rows="3"></textarea>
                                            <div class="layui-form-mid layui-word-aux">
                                                一般不超过100个字符，多个关键词请用英文逗号（,）隔开，建议3到5个关键词。</div>
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">SEO描述</label>
                                        <div class="layui-input-block">
                                            <textarea name="seo_description" placeholder="请输入SEO描述"
                                                class="layui-textarea" rows="3"></textarea>
                                            <div class="layui-form-mid layui-word-aux">一般不超过200个字符，不填写时系统自动提取正文的前200个字符
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 动态字段将追加到这里 -->
                                    <div id="dynamic-fields-container-2"></div>
                                </div>
                            </div>
                        </div>
                        <div class="layui-tabs-item" id="tab-more">
                            <div class="mainBox">
                                <div class="main-container mr-5 pb-6">
                                    <!-- 固定字段：更多设置 -->
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">作者</label>
                                        <div class="layui-input-block">
                                            <input type="text" name="author" value="小编" placeholder="请输入作者"
                                                class="layui-input">
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">来源</label>
                                        <div class="layui-input-block">
                                            <input type="text" name="origin" placeholder="为空时默认'网络'"
                                                class="layui-input">
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">点击数</label>
                                        <div class="layui-input-block">
                                            <input type="number" name="click" value="0" placeholder="请输入点击数"
                                                class="layui-input">
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">阅读权限</label>
                                        <div class="layui-input-block">
                                            <select name="arcrank">
                                                <option value="0">开放浏览</option>
                                                <option value="-1">待审核稿件</option>
                                                <option value="1">注册会员</option>
                                                <option value="2">中级会员</option>
                                                <option value="3">高级会员</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">发布时间</label>
                                        <div class="layui-input-block">
                                            <input type="text" name="add_time" id="add-time" placeholder="请选择发布时间"
                                                class="layui-input">
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">文档模板</label>
                                        <div class="layui-input-block">
                                            <select name="tempview">
                                                <option value="">默认模板</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">自定义文件名</label>
                                        <div class="layui-input-block">
                                            <input type="text" name="htmlfilename" placeholder="自定义文件名"
                                                class="layui-input">
                                            <div class="layui-form-mid layui-word-aux">
                                                自定义文件名可由字母、数字、下划线(_)、连接符(-)等符号组成，除此之外其他字符将自动转为连接符(-)</div>
                                        </div>
                                    </div>
                                    <!-- 动态字段将追加到这里 -->
                                    <div id="dynamic-fields-container-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bottom">
                <div class="layui-form-item" style="margin-bottom: 0;">
                    <div class="layui-input-block">
                        <button type="submit" class="pear-btn pear-btn-primary pear-btn-xs" lay-submit=""
                            lay-filter="save">
                            提交
                        </button>
                        <button type="button" class="pear-btn pear-btn-xs" id="btn-reset">
                            重置
                        </button>
                        <button type="button" class="pear-btn pear-btn-xs" id="btn-back">
                            返回
                        </button>
                    </div>
                </div>
            </div>

    </form>

    <script src="/app/admin/component/layui/layui.js?v=2.13.12"></script>
    <script src="/app/admin/component/pear/pear.js"></script>
    <script src="/app/admin/component/jsoneditor/jsoneditor.js"></script>
    <script src="/app/admin/admin/js/permission.js"></script>

    <script>

        // 相关接口
        const INSERT_API = "/app/admin/archive/insert";

        var editors = {}; // 存储编辑器实例
        var fieldsData = {}; // 存储字段数据（包含初始值dfvalue）

        //提交事件
        layui.use(["form", "pearPopup", "upload", "element", "laydate", "tinymce"], function () {
            var form = layui.form;
            var upload = layui.upload;
            var element = layui.element;
            var laydate = layui.laydate;
            var tinymce = layui.tinymce;
            var $ = layui.$;

            // 获取URL参数
            // var urlParams = new URLSearchParams(window.location.search);
            // var channelId = parseInt(urlParams.get('channel_id')) || 0;

            var urlParams = layui.url().search;
            var channelId = urlParams.channel_id ? parseInt(urlParams.channel_id) : 0;

     
            
            // 标签相关功能
            // 显示常用标签
            window.get_common_tagindex = function(obj) {
                var val = $('#tags').val();
                $('#often_tags').hide();
                $('#often_tags_input').hide();
                $('#tag_loading').show();
                $.ajax({
                    type: 'post',
                    url: '/app/admin/archive/getCommonTags',
                    data: {tags: val, is_click: 1},
                    dataType: 'json',
                    success: function(res) {
                        $('#tag_loading').hide();
                        if (res.code === 0) {
                            if (res.data && res.data.list) {
                                var html = '';
                                if (res.data.list.length > 0) {
                                    res.data.list.forEach(function(item) {
                                        var classAttr = item.selected ? 'cur' : '';
                                        html += '<a class="' + classAttr + '" href="javascript:void(0);" onclick="selectArchivesTag(this)">' + item.tag + '</a>';
                                    });
                                } else {
                                    html = '没有找到记录';
                                }
                                $('#often_tags').html(html).show();
                            }
                        } else {
                            layui.pearPopup.failure(res.msg || '获取标签失败');
                        }
                    },
                    error: function(e) {
                        $('#tag_loading').hide();
                        layui.pearPopup.failure('获取标签失败');
                    }
                });
            };

            // 输入框输入时显示提示标签
            window.get_common_tagindex_input = function(obj) {
                var val = $(obj).val();
                $('#tags_click_count').val(0);
                $('#often_tags_input').hide();
                if (!val || val.trim() === '') {
                    return;
                }
                $.ajax({
                    type: 'post',
                    url: '/app/admin/archive/getCommonTags',
                    data: {tags: val, type: 1},
                    dataType: 'json',
                    success: function(res) {
                        if (res.code === 0) {
                            if (res.data && res.data.list) {
                                var html = '';
                                if (res.data.list.length > 0) {
                                    res.data.list.forEach(function(item) {
                                        var classAttr = item.selected ? 'cur' : '';
                                        html += '<a class="' + classAttr + '" href="javascript:void(0);" onclick="selectArchivesTagInput(this)">' + item.tag + '</a>';
                                    });
                                }
                                if (html) {
                                    $('#often_tags_input').html(html).show();
                                }
                            }
                        }
                    },
                    error: function(e) {
                        // 静默失败
                    }
                });
            };

            // 选择标签（常用标签）
            window.selectArchivesTag = function(obj) {
                event.stopPropagation();
                var newTag = $.trim($(obj).html());
                var tags = $.trim($('#tags').val());
                if (tags != '') {
                    tags = tags.replace(/，/ig, ',');
                    tagsList = tags.split(',');
                } else {
                    tagsList = [];
                }
                if ($.inArray(newTag, tagsList) >= 0) {
                    tagsList.splice($.inArray(newTag, tagsList), 1);
                    $(obj).removeClass('cur');
                } else {
                    tagsList.push(newTag);
                    $(obj).addClass('cur');
                }
                tags = tagsList.join(',');
                $('#tags').val(tags);
            };

            // 选择标签（输入提示）
            window.selectArchivesTagInput = function(obj) {
                event.stopPropagation();
                var newTag = $.trim($(obj).html());
                var tags = $.trim($('#tags').val());
                var count = parseInt($('#tags_click_count').val() || 0);
                if (tags != '') {
                    tags = tags.replace(/，/ig, ',');
                    tagsList = tags.split(',');
                } else {
                    tagsList = [];
                }
                if ($.inArray(newTag, tagsList) >= 0) {
                    tagsList.splice($.inArray(newTag, tagsList), 1);
                    $(obj).removeClass('cur');
                } else {
                    if (count == 0 && tagsList.length > 0) {
                        tagsList.splice(tagsList.length - 1, 1);
                        $(obj).removeClass('cur');
                    }
                    tagsList.push(newTag);
                    $(obj).addClass('cur');
                    $('#tags_click_count').val(count + 1);
                }
                tags = tagsList.join(',');
                $('#tags').val(tags);
            };

            // 点击其他地方隐藏标签列表
            $(document).click(function(e) {
                if (!$(e.target).closest('#tags, #often_tags, #often_tags_input, a[onclick*="get_common_tagindex"], a[onclick*="selectArchivesTag"]').length) {
                    $('#often_tags').hide();
                    $('#often_tags_input').hide();
                }
            });

            // 点击标签列表区域时不隐藏
            $('#often_tags, #often_tags_input').click(function(e) {
                e.stopPropagation();
            });

            // 初始化 tabs（Layui 会自动处理切换逻辑）
            element.render('tabs', 'archive-tabs');

            // 初始化日期选择器
            laydate.render({
                elem: '#add-time',
                type: 'datetime',
                value: new Date()
            });

            // 初始化封面图片上传
            upload.render({
                elem: '#upload-litpic',
                url: '/app/admin/upload/image',
                accept: 'images',
                done: function (res) {
                    if (res.code === 0) {
                        $('#preview-litpic').attr('src', res.data.url).show();
                        $('#input-litpic').val(res.data.url);
                        $('#text-litpic').html('');
                    } else {
                        $('#text-litpic').html('<span style="color: red;">上传失败：' + (res.msg || '未知错误') + '</span>');
                    }
                }
            });

            // 监听栏目选择变化
            form.on('select(typeid)', function (data) {
                var typeid = data.value;
                if (typeid && typeid > 0) {
                    // 获取选中栏目的 channelId
                    var selectedChannelId = channelId; // 使用全局的 channelId
                    // 如果全局 channelId 为空，尝试从 URL 获取
                    if (!selectedChannelId || selectedChannelId <= 0) {
                        var urlParams = layui.url().search;
                        selectedChannelId = urlParams.channel_id ? parseInt(urlParams.channel_id) : 0;
                    }
                    loadChannelfields(typeid, selectedChannelId);
                } else {
                    // 清空动态字段
                    $('#dynamic-fields-container-1').empty();
                    $('#dynamic-fields-container-2').empty();
                    $('#dynamic-fields-container-3').empty();
                    // 清空模板下拉框
                    var $tempviewSelect = $('select[name="tempview"]');
                    $tempviewSelect.empty();
                    $tempviewSelect.append('<option value="">默认模板</option>');
                    form.render();
                }
            });

            // 页面加载时初始化
            loadArctypeOptions();

            // 返回按钮点击事件
            $(document).on('click', '#btn-back', function () {
                if (parent && parent.refreshTable) {
                    parent.refreshTable();
                }
            });


            // 重置按钮点击事件
            $(document).on('click', '#btn-reset', function () {
                resetForm();
            });

            // 页面加载时立即初始化内容编辑器（使用 requestAnimationFrame 确保 DOM 已准备好）
            function initContentEditors() {
                var $contentWrapper = $('#content-editor-wrapper');
                if ($contentWrapper.length > 0) {
                    // 初始化 content 编辑器
                    var $editorContent = $('#editor-content');
                    if ($editorContent.length > 0 && typeof tinymce !== 'undefined' && !editors['content']) {
                        editors['content'] = tinymce.render({
                            elem: '#editor-content',
                            height: 400
                        });
                    }

                    // 初始化 content_ey_m 编辑器
                    var $editorContentEyM = $('#editor-content-ey-m');
                    if ($editorContentEyM.length > 0 && typeof tinymce !== 'undefined' && !editors['content_ey_m']) {
                        editors['content_ey_m'] = tinymce.render({
                            elem: '#editor-content-ey-m',
                            height: 400
                        });
                    }

                    // 渲染 tabs
                    element.render('tabs', 'content-tabs');
                }
            }

            // 使用 requestAnimationFrame 确保在下一帧立即初始化，避免延迟感
            if (window.requestAnimationFrame) {
                requestAnimationFrame(function () {
                    requestAnimationFrame(initContentEditors);
                });
            } else {
                setTimeout(initContentEditors, 0);
            }

            // 字段验证允许为空
            form.verify({
                phone: [/(^$)|^1\d{10}$/, "请输入正确的手机号"],
                email: [/(^$)|^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/, "邮箱格式不正确"],
                url: [/(^$)|(^#)|(^http(s*):\/\/[^\s]+\.[^\s]+)/, "链接格式不正确"],
                number: [/(^$)|^\d+$/, '只能填写数字'],
                date: [/(^$)|^(\d{4})[-\/](\d{1}|0\d{1}|1[0-2])([-\/](\d{1}|0\d{1}|[1-2][0-9]|3[0-1]))*$/, "日期格式不正确"],
                identity: [/(^$)|(^\d{15}$)|(^\d{17}(x|X|\d)$)/, "请输入正确的身份证号"]
            });


            form.on("submit(save)", function (data) {
                var formData = processFormData(data.field, editors, $);

                $.ajax({
                    url: INSERT_API,
                    type: "POST",
                    dateType: "json",
                    data: formData,
                    success: function (res) {
                        if (res.code) {
                            return layui.pearPopup.failure(res.msg);
                        }
                        return layui.pearPopup.success("操作成功", function () {
                            if (parent && parent.refreshTable) {
                                parent.refreshTable();
                            }
                        });
                    }
                });
                return false;
            });

            // 加载栏目下拉选项（根据channel_id过滤，只显示该模型下的栏目）
            function loadArctypeOptions() {
                // 从URL参数中获取channel_id和typeid
                var urlParams = layui.url().search;
                var channelId = urlParams.channel_id ? parseInt(urlParams.channel_id) : 0;
                var urlTypeid = urlParams.typeid ? parseInt(urlParams.typeid) : 0;

                // 使用getArctypeList接口，支持根据channeltype过滤
                var requestParams = { format: 'tree', limit: 2000 };
                if (channelId > 0) {
                    requestParams.channeltype = channelId;
                }

                $.ajax({
                    url: "/app/admin/channelfield/getArctypeList",
                    type: 'get',
                    dataType: 'json',
                    data: requestParams,
                    success: function (result) {
                        if (result.code === 0 && result.data && Array.isArray(result.data)) {
                            var $select = $('#typeid-select');
                            $select.empty();
                            $select.append('<option value="">请选择栏目</option>');

                            // 扁平化树形数据
                            var options = flattenTree(result.data);

                            options.forEach(function (item) {
                                // 如果栏目是单页模型（current_channel=6）或留言模型（current_channel=8），禁用该选项
                                var disabled = '';
                                if (item.current_channel == 6 || item.current_channel == 8) {
                                    disabled = ' disabled';
                                }
                                $select.append('<option value="' + item.id + '"' + disabled + '>' + item.label + '</option>');
                            });
                            
                            // 如果URL中有typeid，设置下拉框的值
                            if (urlTypeid > 0) {
                                $select.val(urlTypeid);
                            }
                            
                            form.render('select');
                            
                                // 如果URL中有typeid和channel_id，自动加载动态字段
                            if (urlTypeid > 0 && channelId > 0) {
                                loadChannelfields(urlTypeid, channelId);
                            } else if (channelId > 0) {
                                // 即使没有 typeid，如果有 channelId，也加载模板列表
                                loadTemplateList(channelId, 'view');
                            }
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('加载栏目数据请求失败:', error);
                    }
                });
            }

                                // 加载动态字段
            function loadChannelfields(typeid, channelId) {
                // 如果未传递channelId，尝试从URL参数中获取
                if (!channelId || channelId <= 0) {
                    var urlParams = layui.url().search;
                    channelId = urlParams.channel_id ? parseInt(urlParams.channel_id) : 0;
                }
                
                if (channelId <= 0) {
                    return;
                }
                
                                var requestData = {
                                    channel_id: channelId,
                                    limit: 1000,
                    only_published: 1,  // 只获取已发布的字段
                                    typeid: typeid
                                };

                                $.ajax({
                                    url: "/app/admin/channelfield/select",
                                    type: 'get',
                                    dataType: 'json',
                                    data: requestData,
                                    success: function (result) {
                                        if (result.code === 0 && result.data) {
                                            renderFields(result.data);
                                        }
                                    }
                                });

                // 加载文档模板列表
                loadTemplateList(channelId, 'view');
            }

            // 加载模板文件列表
            function loadTemplateList(channelId, type) {
                // type: 'view' 表示文档模板
                if (!channelId || channelId <= 0) {
                    return;
                }
                var params = {
                    channel_id: channelId,
                    type: type
                };
                $.getJSON('/app/admin/arctype/getTemplates', params, function (res) {
                    if (res.code === 0 && Array.isArray(res.data)) {
                        var $tempviewSelect = $('select[name="tempview"]');
                        $tempviewSelect.empty();
                        $tempviewSelect.append('<option value="">默认模板</option>');
                        res.data.forEach(function (template) {
                            $tempviewSelect.append('<option value="' + template.value + '">' + template.name + '</option>');
                        });
                        form.render('select');
                    }
                }).fail(function () {
                    // 静默失败
                });
            }

            // 渲染动态字段
            function renderFields(fields) {
                var $contentWrapper = $('#content-editor-wrapper');
                var $contentTabs = $('#content-editor-tabs');
                var hasContent = false;
                var hasContentEyM = false;
                var contentField = null;
                var contentEyMField = null;

                // 清空所有标签页的动态字段容器（保留固定字段）
                $('#dynamic-fields-container-1').empty();
                $('#dynamic-fields-container-2').empty();
                $('#dynamic-fields-container-3').empty();

                // 默认显示内容编辑器，检查字段的 ifeditable 状态来决定是否隐藏
                var contentIfeditable = null;
                var contentEyMIfeditable = null;

                fields.forEach(function (field) {
                    var fieldName = field.name || '';
                    if (fieldName === 'content') {
                        hasContent = true;
                        contentField = field;
                        contentIfeditable = field.ifeditable;
                    } else if (fieldName === 'content_ey_m') {
                        hasContentEyM = true;
                        contentEyMField = field;
                        contentEyMIfeditable = field.ifeditable;
                    }
                });

                // 默认显示编辑器区域
                $contentWrapper.show();

                // 根据字段的 ifeditable 状态显示/隐藏对应的标签
                if (hasContent && contentIfeditable == 0) {
                    $contentTabs.find('li[lay-id="pc"]').hide();
                    $contentTabs.find('#tab-pc').removeClass('layui-show');
                    if (hasContentEyM && contentEyMIfeditable != 0) {
                        $contentTabs.find('li[lay-id="mobile"]').addClass('layui-this');
                        $contentTabs.find('#tab-mobile').addClass('layui-show');
                    }
                } else if (hasContent) {
                    $contentTabs.find('li[lay-id="pc"]').show();
                }

                if (hasContentEyM && contentEyMIfeditable == 0) {
                    $contentTabs.find('li[lay-id="mobile"]').hide();
                } else if (hasContentEyM) {
                    $contentTabs.find('li[lay-id="mobile"]').show();
                }

                // 如果两个标签都隐藏了，则隐藏整个编辑器区域
                var pcHidden = hasContent && contentIfeditable == 0;
                var mobileHidden = hasContentEyM && contentEyMIfeditable == 0;
                if (pcHidden && mobileHidden) {
                    $contentWrapper.hide();
                } else {
                    element.render('tabs', 'content-tabs');
                }

                // 将所有字段（除了 content 和 content_ey_m）都渲染到基础内容标签页（标签页1）
                var fieldsToRender = [];
                fields.forEach(function (field) {
                    // 不过滤任何字段，渲染所有后端返回的字段
                    var fieldName = field.name || '';
                    if (fieldName === 'content' || fieldName === 'content_ey_m') {
                        return;  // content 和 content_ey_m 单独处理
                    }
                    fieldsToRender.push(field);
                    // 保存字段数据（包含初始值dfvalue），用于重置时恢复
                    fieldsData[fieldName] = {
                        dfvalue: field.dfvalue || '',
                        dtype: field.dtype || '',
                        define: field.define || ''
                    };
                });

                // 将所有字段渲染到基础内容标签页（标签页1）
                renderTabFields(fieldsToRender, 1);

                // 重新渲染表单
                form.render();

                // 监听 typeid 字段变化
                var $typeidField = $('[name="typeid"]');
                if ($typeidField.length > 0) {
                    $typeidField.off('change').on('change', function () {
                        var typeid = $(this).val();
                        if (typeid && typeid > 0) {
                            loadChannelfields(typeid, channelId);
                        }
                    });
                }

                // 初始化编辑器和上传（在所有字段渲染完成后，立即初始化避免延迟感）
                function initEditorsAndUploads() {
                    var shouldInitContent = !hasContent || (hasContent && contentField && contentField.ifeditable != 0);
                    var shouldInitContentEyM = !hasContentEyM || (hasContentEyM && contentEyMField && contentEyMField.ifeditable != 0);

                    if (shouldInitContent) {
                        var $editorContent = $('#editor-content');
                        if ($editorContent.length > 0 && typeof tinymce !== 'undefined' && !editors['content']) {
                            editors['content'] = tinymce.render({
                                elem: '#editor-content',
                                height: 400
                            });
                        }
                    }

                    if (shouldInitContentEyM) {
                        var $editorContentEyM = $('#editor-content-ey-m');
                        if ($editorContentEyM.length > 0 && typeof tinymce !== 'undefined' && !editors['content_ey_m']) {
                            editors['content_ey_m'] = tinymce.render({
                                elem: '#editor-content-ey-m',
                                height: 400
                            });
                        }
                    }

                    // 为其他 htmltext 类型的字段初始化 tinymce 编辑器
                    fields.forEach(function (field) {
                        if (field.ifeditable == 1 && field.dtype === 'htmltext') {
                            var fieldName = field.name || '';
                            if (fieldName === 'content' || fieldName === 'content_ey_m') {
                                return;
                            }
                            var editorId = 'editor-' + fieldName;
                            var $editor = $('#' + editorId);
                            if ($editor.length > 0 && typeof tinymce !== 'undefined' && !editors[fieldName]) {
                                editors[fieldName] = tinymce.render({
                                    elem: '#' + editorId,
                                    height: 400
                                });
                            }
                        }
                    });

                    // 初始化上传
                    initUploadFields(fields);
                }

                // 使用 requestAnimationFrame 立即初始化，避免延迟感
                if (window.requestAnimationFrame) {
                    requestAnimationFrame(initEditorsAndUploads);
                } else {
                    setTimeout(initEditorsAndUploads, 0);
                }
            }

            // 渲染指定标签页的字段
            function renderTabFields(fields, tabIndex) {
                var $container = $('#dynamic-fields-container-' + tabIndex);
                fields.forEach(function (field) {
                    $container.append(generateFieldHtml(field));
                });
            }

            // 初始化上传字段
            function initUploadFields(fields) {
                fields.forEach(function (field) {
                    if (field.ifeditable != 1) return;

                    var fieldName = field.name || '';
                    var fieldType = field.dtype || '';

                    if (fieldType === 'img') {
                        upload.render({
                            elem: '#upload-' + fieldName,
                            url: '/app/admin/upload/image',
                            accept: 'images',
                            done: function (res) {
                                if (res.code === 0) {
                                    $('#preview-' + fieldName).attr('src', res.data.url).show();
                                    $('#input-' + fieldName).val(res.data.url);
                                    $('#text-' + fieldName).html('');
                                } else {
                                    $('#text-' + fieldName).html('<span style="color: red;">上传失败：' + (res.msg || '未知错误') + '</span>');
                                }
                            }
                        });
                    } else if (fieldType === 'imgs') {
                        upload.render({
                            elem: '#upload-' + fieldName,
                            url: '/app/admin/upload/image',
                            accept: 'images',
                            multiple: true,
                            done: function (res) {
                                if (res.code === 0) {
                                    var item = $('<div style="display: inline-block; margin-right: 10px; margin-bottom: 10px; position: relative;">');
                                    item.append('<img src="' + res.data.url + '" style="width: 100px; height: 100px; object-fit: cover;">');
                                    item.append('<input type="hidden" name="' + fieldName + '[]" value="' + res.data.url + '">');
                                    item.append('<button type="button" class="layui-btn layui-btn-xs layui-btn-danger" onclick="$(this).parent().remove()" style="position: absolute; top: 0; right: 0;">删除</button>');
                                    $('#list-' + fieldName).append(item);
                                }
                            }
                        });
                    } else if (fieldType === 'files') {
                        upload.render({
                            elem: '#upload-' + fieldName,
                            url: '/app/admin/upload/file',
                            accept: 'file',
                            done: function (res) {
                                if (res.code === 0) {
                                    var item = $('<div style="margin-bottom: 10px;">');
                                    item.append('<span>' + res.data.name + '</span>');
                                    item.append('<input type="hidden" name="' + fieldName + '[]" value="' + res.data.url + '">');
                                    item.append('<button type="button" class="layui-btn layui-btn-xs layui-btn-danger" onclick="$(this).parent().remove()">删除</button>');
                                    $('#list-' + fieldName).append(item);
                                }
                            }
                        });
                    }
                });
            }

            // 重置表单 - 恢复初始值（保留动态字段结构）
            function resetForm() {
                // 先重置动态字段的值（恢复初始值，保留字段结构，不清空容器）
                var $dynamicContainers = $('#dynamic-fields-container-1, #dynamic-fields-container-2, #dynamic-fields-container-3');
                
                // 遍历所有动态字段，恢复初始值
                Object.keys(fieldsData).forEach(function (fieldName) {
                    var fieldInfo = fieldsData[fieldName];
                    var dfvalue = fieldInfo.dfvalue || '';
                    var fieldType = fieldInfo.dtype || '';
                    var $field = $dynamicContainers.find('[name="' + fieldName + '"]');
                    
                    if ($field.length > 0) {
                        if (fieldType === 'select' || fieldType === 'selects') {
                            $field.val(dfvalue || '');
                        } else if (fieldType === 'radio' || fieldType === 'radios') {
                            $field.filter('[value="' + dfvalue + '"]').prop('checked', true);
                            $field.not('[value="' + dfvalue + '"]').prop('checked', false);
                        } else if (fieldType === 'checkbox' || fieldType === 'checkboxs') {
                            var dfvalueArray = dfvalue ? String(dfvalue).split(',') : [];
                            $field.each(function () {
                                var $checkbox = $(this);
                                var value = $checkbox.val();
                                $checkbox.prop('checked', dfvalueArray.indexOf(value) >= 0);
                            });
                        } else if (fieldType === 'switch') {
                            $field.prop('checked', (dfvalue == 1 || dfvalue === '1'));
                        } else if (fieldType === 'img') {
                            if (dfvalue) {
                                $('#preview-' + fieldName).attr('src', dfvalue).show();
                                $('#input-' + fieldName).val(dfvalue);
                            } else {
                                $('#preview-' + fieldName).attr('src', '').hide();
                                $('#input-' + fieldName).val('');
                            }
                            $('#text-' + fieldName).html('');
                        } else if (fieldType === 'imgs') {
                            $('#list-' + fieldName).empty();
                            // 多图字段的初始值处理（如果需要）
                        } else if (fieldType === 'htmltext') {
                            // htmltext 类型的字段通过编辑器处理
                            var editorId = '#editor-' + fieldName;
                            var editorInstance = typeof tinymce !== 'undefined' && tinymce.get ? tinymce.get(editorId) : null;
                            if (editorInstance && typeof editorInstance.setContent === 'function') {
                                editorInstance.setContent(dfvalue || '');
                            } else {
                                $(editorId).val(dfvalue || '');
                            }
                        } else {
                            // text, textarea, int, float, decimal, datetime, media, multitext 等
                            $field.val(dfvalue || '');
                        }
                    }
                });

                // 重置固定字段的值
                $('input[type="text"]:not([name="author"]), input[type="number"]:not([name="click"])').not($dynamicContainers.find('input')).val('');
                $('textarea').not($dynamicContainers.find('textarea')).val('');
                $('select').not($dynamicContainers.find('select')).each(function () {
                    $(this).val($(this).find('option:first').val());
                });
                $('input[type="checkbox"]').not($dynamicContainers.find('input')).prop('checked', false);
                $('input[type="radio"]').not($dynamicContainers.find('input')).prop('checked', false);

                // 清空编辑器内容（包括动态字段的编辑器）
                Object.keys(editors).forEach(function (fieldName) {
                    if (editors[fieldName]) {
                        // 使用 tinymce.get 获取编辑器实例
                        var editorId = fieldName === 'content' ? '#editor-content' : (fieldName === 'content_ey_m' ? '#editor-content-ey-m' : '#editor-' + fieldName);
                        var editorInstance = typeof tinymce !== 'undefined' && tinymce.get ? tinymce.get(editorId) : null;
                        if (editorInstance && typeof editorInstance.setContent === 'function') {
                            editorInstance.setContent('');
                        } else if (editors[fieldName] && typeof editors[fieldName].setContent === 'function') {
                            editors[fieldName].setContent('');
                        }
                        // 同时清空对应的 textarea
                        var $editor = $(editorId);
                        if ($editor.length > 0) {
                            $editor.val('');
                        }
                    }
                });

                // 清空 content 和 content_ey_m 编辑器（如果存在）
                var $editorContent = $('#editor-content');
                if ($editorContent.length > 0) {
                    var editorContentInstance = typeof tinymce !== 'undefined' && tinymce.get ? tinymce.get('#editor-content') : null;
                    if (editorContentInstance && typeof editorContentInstance.setContent === 'function') {
                        editorContentInstance.setContent('');
                    }
                    $editorContent.val('');
                }

                var $editorContentEyM = $('#editor-content-ey-m');
                if ($editorContentEyM.length > 0) {
                    var editorContentEyMInstance = typeof tinymce !== 'undefined' && tinymce.get ? tinymce.get('#editor-content-ey-m') : null;
                    if (editorContentEyMInstance && typeof editorContentEyMInstance.setContent === 'function') {
                        editorContentEyMInstance.setContent('');
                    }
                    $editorContentEyM.val('');
                }

                // 清空封面图片预览和隐藏字段
                $('#preview-litpic').attr('src', '').hide();
                $('#input-litpic').val('');
                $('#text-litpic').html('');

                // 重置日期选择器为当前时间
                laydate.render({
                    elem: '#add-time',
                    type: 'datetime',
                    value: new Date()
                });

                // 重置作者字段为默认值
                $('input[name="author"]').val('小编');

                // 重置点击数
                $('input[name="click"]').val('0');

                // 重置阅读权限
                $('select[name="arcrank"]').val('0');

                // 恢复栏目选择到初始值（从URL参数中获取）
                var urlParams = layui.url().search;
                var initialTypeid = urlParams.typeid ? parseInt(urlParams.typeid) : 0;
                if (initialTypeid > 0) {
                    $('#typeid-select').val(initialTypeid);
                } else {
                    // 如果没有URL参数，保持当前选择
                }

                // 重新渲染表单
                form.render();

                // 提示用户
                layui.pearPopup.success('表单已重置');
            }


        });


        // ==================== 工具函数 ====================


        /**
         * 将树形数据拍平成带缩进的下拉选项
         * @param {Array} nodes 树形节点数组
         * @param {number} level 当前层级
         * @returns {Array} 扁平化的选项数组
         */
        function flattenTree(nodes, level) {
            level = level || 0;
            var list = [];
            if (!nodes || !Array.isArray(nodes)) {
                return list;
            }
            nodes.forEach(function (node) {
                if (!node) return;
                var indent = level > 0 ? '├─'.repeat(level) : '';
                var name = node.title || node.name || node.typename || '未命名';
                list.push({
                    id: node.id,
                    label: indent + name,
                    current_channel: node.current_channel || 0
                });
                if (node.children && Array.isArray(node.children) && node.children.length > 0) {
                    list = list.concat(flattenTree(node.children, level + 1));
                }
            });
            return list;
        }

        /**
         * 获取字段所属的标签页索引
         * @param {string} fieldName 字段名
         * @returns {number} 1-基础内容, 2-SEO优化, 3-更多设置
         */
        function getFieldTabIndex(fieldName) {
            var seoFields = ['seo_title', 'seo_keywords', 'seo_description'];
            if (seoFields.indexOf(fieldName) >= 0) {
                return 2;
            }
            var moreFields = ['author', 'origin', 'click', 'arcrank', 'add_time', 'update_time', 'tempview',
                'status', 'sort_order', 'lang', 'admin_id', 'users_id', 'arc_level_id',
                'restric_type', 'users_score', 'is_del', 'del_method', 'joinaid', 'downcount',
                'appraise', 'collection', 'htmlfilename', 'province_id', 'city_id', 'area_id',
                'removal_time', 'no_vip_pay', 'editor_remote_img_local', 'editor_img_clear_link',
                'editor_ai_create', 'reason', 'stock_code', 'stypeid', 'channel', 'is_b',
                'is_head', 'is_special', 'is_top', 'is_recom', 'is_jump', 'is_litpic',
                'is_roll', 'is_slide', 'is_diyattr', 'jumplinks', 'ismake', 'attrlist_id',
                'merchant_id', 'free_shipping', 'users_price', 'crossed_price',
                'users_discount_type', 'users_free', 'old_price', 'sales_num',
                'virtual_sales', 'sales_all', 'stock_count', 'stock_show', 'prom_type',
                'logistics_type'];
            if (moreFields.indexOf(fieldName) >= 0) {
                return 3;
            }
            return 1;
        }

        /**
         * 解析选项定义字符串
         * @param {string} fieldDefine 选项定义字符串，格式：选项1|值1,选项2|值2
         * @returns {Array} 选项数组 [{text, value}]
         */
        function parseFieldOptions(fieldDefine) {
            if (!fieldDefine) return [];
            var options = [];
            fieldDefine.split(',').forEach(function (option) {
                var parts = option.split('|');
                options.push({
                    text: parts[0].trim(),
                    value: parts.length > 1 ? parts[1].trim() : parts[0].trim()
                });
            });
            return options;
        }

        /**
         * 根据字段类型生成字段HTML
         * @param {Object} field 字段对象
         * @returns {string} 字段HTML
         */
        function generateFieldHtml(field) {
            var fieldName = field.name || '';
            var fieldTitle = field.title || fieldName;
            var fieldType = field.dtype || 'text';
            var fieldDefine = field.define || '';
            var maxlength = field.maxlength || '';
            var dfvalue = field.dfvalue || '';
            var remark = field.remark || '';
            var isRequired = field.ifrequire == 1;
            var requiredAttr = isRequired ? 'lay-verify="required"' : '';

            var fieldHtml = '<div class="layui-form-item" data-field-name="' + fieldName + '">';
            fieldHtml += '<label class="layui-form-label">' + fieldTitle + '</label>';
            fieldHtml += '<div class="layui-input-block">';

            // 根据字段类型生成不同的控件
            switch (fieldType) {
                case 'htmltext':
                    fieldHtml += '<textarea id="editor-' + fieldName + '" name="' + fieldName + '" cols="30" rows="10">' + (dfvalue || '') + '</textarea>';
                    break;
                case 'text':
                case 'int':
                case 'float':
                case 'datetime':
                    var inputType = fieldType === 'int' || fieldType === 'float' ? 'number' : (fieldType === 'datetime' ? 'datetime-local' : 'text');
                    var maxlengthAttr = maxlength ? 'maxlength="' + maxlength + '"' : '';
                    fieldHtml += '<input type="' + inputType + '" name="' + fieldName + '" value="' + (dfvalue || '') + '" class="layui-input" ' + requiredAttr + ' ' + maxlengthAttr + '>';
                    break;
                case 'textarea':
                    var rows = fieldDefine ? parseInt(fieldDefine) : 3;
                    var maxlengthAttr = maxlength ? 'maxlength="' + maxlength + '"' : '';
                    fieldHtml += '<textarea name="' + fieldName + '" class="layui-textarea" rows="' + rows + '" ' + requiredAttr + ' ' + maxlengthAttr + '>' + (dfvalue || '') + '</textarea>';
                    break;
                case 'select':
                case 'selects':
                    fieldHtml += '<select name="' + fieldName + '" ' + requiredAttr + '>';
                    fieldHtml += '<option value="">请选择</option>';
                    var options = parseFieldOptions(fieldDefine);
                    options.forEach(function (opt) {
                        var selected = (dfvalue == opt.value) ? 'selected' : '';
                        fieldHtml += '<option value="' + opt.value + '" ' + selected + '>' + opt.text + '</option>';
                    });
                    fieldHtml += '</select>';
                    break;
                case 'radio':
                case 'radios':
                    // 对于 radio 类型，使用 dfvalue 来生成选项（逗号分隔的字符串）
                    var radioOptions = [];
                    if (dfvalue) {
                        // dfvalue 格式：选项1,选项2,选项3
                        dfvalue.split(',').forEach(function (option) {
                            var optionValue = option.trim();
                            if (optionValue) {
                                radioOptions.push({
                                    text: optionValue,
                                    value: optionValue
                                });
                            }
                        });
                    }
                    // 如果 dfvalue 为空，尝试从 define 解析 enum 格式
                    if (radioOptions.length === 0 && fieldDefine) {
                        // define 格式可能是：enum('值1','值2','值3') 或 选项1|值1,选项2|值2
                        if (fieldDefine.indexOf('enum(') === 0) {
                            // 解析 enum 格式
                            var enumMatch = fieldDefine.match(/enum\(([^)]+)\)/);
                            if (enumMatch && enumMatch[1]) {
                                enumMatch[1].split(',').forEach(function (option) {
                                    var optionValue = option.trim().replace(/^'|'$/g, '').replace(/^"|"$/g, '');
                                    if (optionValue) {
                                        radioOptions.push({
                                            text: optionValue,
                                            value: optionValue
                                        });
                                    }
                                });
                            }
                        } else {
                            // 使用 parseFieldOptions 解析其他格式
                            radioOptions = parseFieldOptions(fieldDefine);
                        }
                    }
                    radioOptions.forEach(function (opt) {
                        var checked = (dfvalue == opt.value) ? 'checked' : '';
                        fieldHtml += '<input type="radio" name="' + fieldName + '" value="' + opt.value + '" title="' + opt.text + '" ' + checked + '>';
                    });
                    break;
                case 'checkbox':
                case 'checkboxs':
                    var checkboxOptions = parseFieldOptions(fieldDefine);
                    var dfvalueArray = dfvalue ? String(dfvalue).split(',') : [];
                    checkboxOptions.forEach(function (opt) {
                        var checked = dfvalueArray.indexOf(opt.value) >= 0 ? 'checked' : '';
                        fieldHtml += '<input type="checkbox" name="' + fieldName + '[]" value="' + opt.value + '" title="' + opt.text + '" ' + checked + '>';
                    });
                    break;
                case 'img':
                    fieldHtml += '<div class="layui-upload">';
                    fieldHtml += '<button type="button" class="layui-btn layui-btn-normal" id="upload-' + fieldName + '">选择图片</button>';
                    fieldHtml += '<div class="layui-upload-list" style="margin-top: 10px;">';
                    fieldHtml += '<img class="layui-upload-img" id="preview-' + fieldName + '" src="' + (dfvalue || '') + '" style="max-width: 200px; max-height: 200px; display: ' + (dfvalue ? 'block' : 'none') + ';">';
                    fieldHtml += '<input type="hidden" name="' + fieldName + '" id="input-' + fieldName + '" value="' + (dfvalue || '') + '">';
                    fieldHtml += '<p id="text-' + fieldName + '" style="margin-top: 10px;"></p>';
                    fieldHtml += '</div></div>';
                    break;
                case 'imgs':
                    fieldHtml += '<div class="layui-upload">';
                    fieldHtml += '<button type="button" class="layui-btn layui-btn-normal" id="upload-' + fieldName + '">选择多图</button>';
                    fieldHtml += '<div class="layui-upload-list" id="list-' + fieldName + '" style="margin-top: 10px;"></div>';
                    fieldHtml += '</div>';
                    break;
                case 'files':
                    fieldHtml += '<div class="layui-upload">';
                    fieldHtml += '<button type="button" class="layui-btn layui-btn-normal" id="upload-' + fieldName + '">选择文件</button>';
                    fieldHtml += '<div class="layui-upload-list" id="list-' + fieldName + '" style="margin-top: 10px;"></div>';
                    fieldHtml += '</div>';
                    break;
                case 'media':
                    fieldHtml += '<input type="text" name="' + fieldName + '" value="' + (dfvalue || '') + '" class="layui-input" placeholder="请输入视频地址" ' + requiredAttr + '>';
                    break;
                case 'switch':
                    var checked = (dfvalue == 1 || dfvalue === '1') ? 'checked' : '';
                    fieldHtml += '<input type="checkbox" name="' + fieldName + '" value="1" lay-skin="switch" lay-text="开启|关闭" ' + checked + '>';
                    break;
                case 'decimal':
                    fieldHtml += '<input type="number" name="' + fieldName + '" value="' + (dfvalue || '0.00') + '" class="layui-input" step="0.01" ' + requiredAttr + '>';
                    break;
                case 'multitext':
                    var rows = fieldDefine ? parseInt(fieldDefine) : 5;
                    var maxlengthAttr = maxlength ? 'maxlength="' + maxlength + '"' : '';
                    fieldHtml += '<textarea name="' + fieldName + '" class="layui-textarea" rows="' + rows + '" ' + requiredAttr + ' ' + maxlengthAttr + '>' + (dfvalue || '') + '</textarea>';
                    break;
            }

            if (remark) {
                fieldHtml += '<div class="layui-form-mid layui-word-aux">' + remark + '</div>';
            }

            fieldHtml += '</div></div>';
            return fieldHtml;
        }

        /**
         * 处理表单数据（收集编辑器内容、处理复选框、switch、图片等字段）
         * @param {Object} formData 原始表单数据
         * @param {Object} editors 编辑器实例对象
         * @param {Function} $ jQuery函数
         * @returns {Object} 处理后的表单数据
         */
        function processFormData(formData, editors, $) {
                // 获取所有文本编辑器的内容
                Object.keys(editors).forEach(function (fieldName) {
                    if (editors[fieldName]) {
                        formData[fieldName] = editors[fieldName].getContent();
                    }
                });

                // 处理复选框字段（将数组转换为逗号分隔的字符串）
                Object.keys(formData).forEach(function (key) {
                    if (key.endsWith('[]') && Array.isArray(formData[key])) {
                        var newKey = key.replace('[]', '');
                        formData[newKey] = formData[key].join(',');
                        delete formData[key];
                    }
                });

                // 处理 switch 字段
                $('input[type="checkbox"][lay-skin="switch"]').each(function () {
                    var fieldName = $(this).attr('name');
                    if (!formData[fieldName]) {
                        formData[fieldName] = 0;
                    } else {
                        formData[fieldName] = 1;
                    }
                });

                // 处理多图字段
                $('input[type="hidden"][name$="[]"]').each(function () {
                    var fieldName = $(this).attr('name').replace('[]', '');
                    if (!formData[fieldName] || !Array.isArray(formData[fieldName])) {
                        formData[fieldName] = [];
                    }
                    var value = $(this).val();
                    if (value) {
                        formData[fieldName].push(value);
                    }
                });

                // 处理单图字段
                $('input[type="hidden"][id^="input-"]').each(function () {
                    var id = $(this).attr('id');
                    var fieldName = id.replace('input-', '');
                    formData[fieldName] = $(this).val();
                });

            return formData;
        }

    </script>

</body>

</html>